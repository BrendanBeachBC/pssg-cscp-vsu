<html>

<head>
</head>

<body style="overflow-wrap: break-word;">
    <link href="https://use.fontawesome.com/releases/v5.5.0/css/all.css" rel="stylesheet" integrity="sha384-B4dIYHKNBt8Bc12p+WXckhzcICo0wtJAoU8YZTY5qE0Id1GSseTk6S+L3BlXeVIU" crossorigin="anonymous">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <link rel="stylesheet" type="text/css" href="./Bootstrap.css" />
    <script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
    <title>VSU Cornet</title>
    <meta charset="utf-8">
    <style type="text/css">
        body {
            font-size: 17px;
        }

        .btn {
            min-width: 120px;
            font-size: 16px;
            border-radius: 5px;
            display: inline-block;
            padding: 6px 12px;
            font-weight: 400;
            line-height: 1.42857143;
        }

        .btn.btn-primary {
            background-color: #38598a;
            border: #38598a 1px solid;
            color: #ffffff;
        }

        .btn-primary:hover {
            background-color: rgba(0, 51, 102, 1) !important;
            color: #ffffff;
            border-color: #204d74;
            border-radius: 5px;
        }

        .btn.btn-secondary {
            background-color: #fff;
            border: #ccc 1px solid;
            color: #003366;
        }

        .btn-secondary:hover {
            background-color: #f2f2f2;
        }

        .btn-secondary:focus {
            border-color: #ccc;
            box-shadow: 0 0 0 0.2rem #ccc;
        }

        .btn-outline-primary {
            color: #38598a;
            border-color: #38598a;
        }

        .btn-outline-primary:hover {
            color: #fff;
            background-color: #38598a;
            border-color: #38598a;
        }

        .btn-outline-primary:focus {
            color: #38598a;
            border-color: #38598a;
        }

        .btn-outline-primary:focus:hover {
            color: #fff;
            background-color: #38598a;
            border-color: #38598a;
        }

        .btn.btn-primary.sv_prev_btn {
            background-color: #ccc;
            border: #ccc 1px solid;
            color: #000;
            min-width: 120px;
            font-size: 16px;
            border-radius: 5px;
        }

        .btn.btn-primary.sv_prev_btn:hover {
            background-color: #2f567b !important;
            color: #ffffff;
            border-color: #204d74;
            border-radius: 5px;
        }

        .table td,
        .table th {
            padding: .75rem;
            vertical-align: top;
            border-top: 1px solid #dee2e6 !important;
        }

        P {
            margin: 0;
        }

        input[type="radio"] {
            margin-left: 10px;
            margin-right: 5px;
        }

        input[type="checkbox"] {
            margin-right: 2px;
        }

        label {
            font-weight: normal;
        }

        .required:after {
            content: " *";
            color: red;
        }

        .search-button-container {
            position: relative;
        }

        .search-button {
            position: absolute;
            bottom: 0;
        }

        .is-disabled {
            opacity: 0.6;
            text-decoration: none;
            pointer-events: none;
        }

        .hidden {
            display: none;
        }
    </style>

    <div class="container">
        <!-- hidden -->
        <div class="search-container " id="search-container">
            <div class="row mt-5">
                <div class="col">
                    <h2 class="m-0">CORNET Search</h2>
                </div>
                <div class="col">
                    <input type="radio" name="search_type" value="Exact" id="exact" onchange="searchTypeChange('exact')" checked><label for="exact">Exact Search</label>
                    <input type="radio" name="search_type" value="Partial" id="partial" onchange="searchTypeChange('partial')"><label for="partial">Partial Search</label>
                    <input type="radio" name="search_type" value="Soundex" id="soundex" onchange="searchTypeChange('soundex')"><label for="soundex">Soundex Search</label>
                </div>
            </div>

            <div class="row mt-3">
                <div class="col-md-3">
                    <label for="surname" class="surname required">Surname</label>
                    <br>
                    <input class="form-control surname" type="text" id="surname" name="surname" oninput="surnameChange(this.value)">
                </div>

                <div class="col-md-3">
                    <label for="given_name" class="given_name">Given name</label>
                    <br>
                    <input class="form-control given_name" type="text" id="given_name" name="given_name" oninput="fieldChange(this.value)">
                </div>

                <div class="col-md-3">
                    <label for="second_name" class="second_name">Second name</label>
                    <br>
                    <input class="form-control second_name" type="text" id="second_name" name="second_name" oninput="fieldChange(this.value)">
                </div>

                <div class="col-md-3">
                    <br>
                    <input type="checkbox" class="current_name" id="current_name" name="current_name" onchange="currentNameChange(this.checked)">
                    <label for="current_name" class="current_name">Current Name</label>
                </div>
            </div>

            <div class="row mt-3">
                <div class="col-md-3">
                    <label for="gender" class="gender">Gender</label>
                    <br>
                    <select class="form-control gender" id="gender" name="gender" oninput="fieldChange(this.value)">
                        <option value=""></option>
                        <option value="M">Male</option>
                        <option value="F">Female</option>
                    </select>
                </div>

                <div class="col-md-3 d-flex">
                    <div class="col-6 pl-0">
                        <label for="birth_year" class="birth_year">Birth year</label>
                        <br>
                        <input class="form-control birth_year" type="text" id="birth_year" name="birth_year" placeholder="yyyy" oninput="fieldChange(this.value)">
                    </div>

                    <div class="col-6 pr-0">
                        <label for="year_range" class="year_range">Year range</label>
                        <br>
                        <input class="form-control year_range" type="text" id="year_range" name="year_range" placeholder="+/-" oninput="fieldChange(this.value)">
                    </div>
                </div>

                <div class="col-md-3 d-flex">
                    <div class="col-6 pl-0">
                        <label for="cs" class="cs">CS#</label>
                        <br>
                        <input class="form-control cs" type="text" id="cs" name="cs" oninput="csChange(this.value)">
                    </div>

                    <div class="col-6 pr-0">
                        <label for="fps" class="fps">FPS#</label>
                        <br>
                        <input class="form-control fps" type="text" id="fps" name="fps" oninput="fpsChange(this.value)">
                    </div>
                </div>

                <div class="col-md-3 search-button-container">
                    <button onclick="search()" class="btn btn-primary search-button" id="search-button">SEARCH CORNET</button>
                </div>
            </div>

            <div class="row mt-5 search-results-row hidden">
                <div class="col">
                    <table class="table table-striped" id="client-table">
                        <thead class="thead">
                            <th>Last Name</th>
                            <th>Given Names</th>
                            <th>Current Name</th>
                            <th>Gender</th>
                            <th>Birth date</th>
                            <th>CS#</th>
                            <th>Custody status</th>
                            <th>Actions</th>
                        </thead>

                        <tbody>
                        </tbody>
                    </table>
                </div>

            </div>
        </div>


        <!-- client details section -->
        <div class="client-details-container hidden" id="client-details-container">
            <button onclick="showSearch()" class="btn btn-secondary">Return to Search</button>
        </div>
    </div>

    <script>
        const ROWS_SHOWN = 5;
        let clients = [];
        let displayed_clients = [];
        let current_name = false;
        let _formContext = null;
        window.onload = function () {
            initPaginator();
            this.search_type = "exact";
            $("#search-button").addClass("is-disabled");
        };

        function setClientApiContext(xrm, formContext) {
            // Optionally set Xrm and formContext as global variables on the page.
            window.Xrm = xrm;
            _formContext = formContext;

            let cs_number = _formContext.getAttribute("vsd_csnumber");
            console.log(cs_number);

            if (cs_number) {
                $("#search-container").addClass("hidden");
                $("#client-details-container").removeClass("hidden");
                loadOffender(cs_number);
            }
            else {
                $("#search-container").removeClass("hidden");
            }
        }


        function search() {
            let parameters = {
                SearchType: this.search_type,
                Surname: $('#surname').val(),
                Given1: $('#given_name').val(),
                Given2: $('#second_name').val(),
                Gender: $('#gender').val(),
                BirthYear: $('#birth_year').val(),
                BirthYearRange: $('#year_range').val(),

                UserName: "test",
                FullName: "test",
                Client: "test",
            };

            let type = "";
            let text = "";
            let cs = $('#cs').val();
            let fps = $('#fps').val();

            if (cs) {
                type = "CSNO";
                text = cs;
                parameters.SearchType = "ID";
            }
            else if (fps) {
                type = "FPS";
                text = cs;
                parameters.SearchType = "ID";
            }

            if (type) parameters.IdentifierType = type;
            if (text) parameters.IdentifierText = text;

            console.log(parameters);

            var myHeaders = new Headers();
            myHeaders.append("username", parameters.UserName);
            myHeaders.append("fullname", parameters.FullName);
            myHeaders.append("client", parameters.Client);
            myHeaders.append("Content-Type", "application/json");

            var requestOptions = {
                method: 'POST',
                headers: myHeaders,
                body: JSON.stringify(parameters),
                credentials: "same-origin"
            };

            if (window.location.origin === "file://") {
                console.log("running locally - skipping fetch");
                //test some client results...
                clients = [
                    {
                        "personBirthDate": "1956-02-20",
                        "clientNumber": "00672766",
                        "locationTypeCode": {
                            "custody": null,
                            "community": null
                        },
                        "personName": "D, THOMAS",
                        "personGenderIdentityCodeType": "M",
                        "isCurrentName": "N"
                    },
                    {
                        "personBirthDate": "1958-02-27",
                        "clientNumber": "01230093",
                        "locationTypeCode": {
                            "custody": null,
                            "community": null
                        },
                        "personName": "D, JONATHAN MICHAEL",
                        "personGenderIdentityCodeType": "M",
                        "isCurrentName": "Y"
                    },
                    {
                        "personBirthDate": "1959-12-14",
                        "clientNumber": "01199066",
                        "locationTypeCode": {
                            "custody": null,
                            "community": null
                        },
                        "personName": "D, PARWAAN",
                        "personGenderIdentityCodeType": "M",
                        "isCurrentName": "Y"
                    }
                ];
                addResultsToTable(clients);
                // return;
            }
            let searchUrl = parent.Xrm.Page.context.getClientUrl();
            searchUrl += "/api/data/v9.0/vsd_CORNETOffenderSearch";

            fetch(searchUrl, requestOptions)
                .then(response => response.text())
                .then(res => {
                    let parsed = JSON.parse(res);
                    if (parsed && parsed.Result) {
                        let data = JSON.parse(parsed.Result);
                        console.log(data);
                        addResultsToTable(data.clients);
                    }

                })
                .catch(error => console.log('error', error));
        }

        function addResultsToTable(clients) {
            if (current_name) {
                displayed_clients = clients.filter(c => c.isCurrentName == 'Y');
            }
            else {
                displayed_clients = clients;
            }

            //make sure table shows and any existing rows are removed
            $(".search-results-row").removeClass("hidden");
            $("#client-table").find("tr:gt(0)").remove();

            displayed_clients.forEach((client, i) => {
                let tr = `<tr>
                    <td>${client.personName.split(',')[0]}</td>
                    <td>${client.personName.split(',').splice(1).join(',')}</td>
                    <td>${client.isCurrentName == 'Y' ? '<i class="far fa-check-circle"></i>' : ''}</td>
                    <td>${client.personGenderIdentityCodeType || ''}</td>
                    <td>${client.personBirthDate || ''}</td>
                    <td>${client.clientNumber || ''}</td>
                    <td>${client.locationTypeCode.custody || ''}</td>
                    <td>${client.clientNumber ? '<button onclick="showOffender(' + i + ')" class="btn btn-secondary">View Offender</button>' : ''}</td>
                    
                    </tr>`;
                $("#client-table").append(tr);
            });
            initPaginator();
        }

        function initPaginator() {
            //if existing paginator, remove the old one

            //TODO - update rows shown to use some variable that we can potentially set with a drop down
            let nav = $("#nav");
            if (nav) nav.remove();

            $('#client-table').after('<div id="nav"></div>');
            var rowsShown = ROWS_SHOWN;
            var rowsTotal = $('#client-table tbody tr').length;
            var numPages = rowsTotal / rowsShown;
            for (i = 0; i < numPages; i++) {
                var pageNum = i + 1;
                $('#nav').append('<a href="#" rel="' + i + '">' + pageNum + '</a> ');
            }
            $('#client-table tbody tr').hide();
            $('#client-table tbody tr').slice(0, rowsShown).show();
            $('#nav a:first').addClass('active');
            $('#nav a').bind('click', function () {

                $('#nav a').removeClass('active');
                $(this).addClass('active');
                var currPage = $(this).attr('rel');
                var startItem = currPage * rowsShown;
                var endItem = startItem + rowsShown;
                $('#client-table tbody tr').css('opacity', '0.0').hide().slice(startItem, endItem).css('display', 'table-row').animate({ opacity: 1 }, 300);
            });
        }

        function searchTypeChange(val) {
            this.search_type = val;
            if (val === "exact") {
                $(".given_name").removeClass("is-disabled");
                $(".second_name").removeClass("is-disabled");
                $(".current_name").removeClass("is-disabled");
                $(".current_name_label").removeClass("is-disabled");
                $(".gender").removeClass("is-disabled");
                $(".birth_year").removeClass("is-disabled");
                $(".year_range").removeClass("is-disabled");
            }
            else if (val === "partial" || val === "soundex") {
                $(".given_name").val("");
                $(".second_name").val("");
                $(".current_name").val("");
                $(".gender").val("");
                $(".birth_year").val("");
                $(".year_range").val("");

                $(".given_name").addClass("is-disabled");
                $(".second_name").addClass("is-disabled");
                $(".current_name").addClass("is-disabled");
                $(".current_name_label").addClass("is-disabled");
                $(".gender").addClass("is-disabled");
                $(".birth_year").addClass("is-disabled");
                $(".year_range").addClass("is-disabled");
            }
        }

        function surnameChange(val) {
            if (val) {
                $("#search-button").removeClass("is-disabled");
                $("#cs").val("");
                $("#fps").val("");
            }
            else {
                $("#search-button").addClass("is-disabled");
            }
        }

        function fieldChange(val) {
            if (val) {
                $("#cs").val("");
                $("#fps").val("");
            }
        }

        function csChange(val) {
            if (val) {
                $("#search-button").removeClass("is-disabled");
                $("#surname").val("");
                $("#given_name").val("");
                $("#second_name").val("");
                $("#gender").val("");
                $("#birth_year").val("");
                $("#year_range").val("");
                $("#fps").val("");
            }
            else {
                $("#search-button").addClass("is-disabled");
            }
        }

        function fpsChange(val) {
            if (val) {
                $("#search-button").removeClass("is-disabled");
                $("#surname").val("");
                $("#given_name").val("");
                $("#second_name").val("");
                $("#gender").val("");
                $("#birth_year").val("");
                $("#year_range").val("");
                $("#cs").val("");
            }
            else {
                $("#search-button").addClass("is-disabled");
            }
        }

        function currentNameChange(val) {
            current_name = val;
            addResultsToTable(clients);
        }

        function showOffender(val) {
            console.log(displayed_clients[val].clientNumber);
            $("#search-container").addClass("hidden");
            $("#client-details-container").removeClass("hidden");

            loadOffender(displayed_clients[val].clientNumber);
        }

        function showSearch() {
            $("#search-container").removeClass("hidden");
            $("#client-details-container").addClass("hidden");
        }

        function loadOffender(cs_number) {

        }
    </script>
</body>

</html>