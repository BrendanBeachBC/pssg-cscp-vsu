<html>

<head>
</head>

<body style="overflow-wrap: break-word;">
    <link href="https://use.fontawesome.com/releases/v5.5.0/css/all.css" rel="stylesheet" integrity="sha384-B4dIYHKNBt8Bc12p+WXckhzcICo0wtJAoU8YZTY5qE0Id1GSseTk6S+L3BlXeVIU" crossorigin="anonymous">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <link rel="stylesheet" type="text/css" href="./Bootstrap.css" />
    <script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
    <title>VSU Cornet</title>
    <meta charset="utf-8">
    <style type="text/css">
        body {
            font-size: 17px;
        }

        .flex-container {
            display: flex;
            flex-wrap: wrap;
        }

        .nav-link {
            cursor: pointer;
        }

        .active-page {
            font-weight: bold;
            text-decoration: underline !important;
        }

        .btn {
            min-width: 120px;
            font-size: 16px;
            border-radius: 5px;
            display: inline-block;
            padding: 6px 12px;
            font-weight: 400;
            line-height: 1.42857143;
        }

        .btn.btn-primary {
            background-color: #38598a;
            border: #38598a 1px solid;
            color: #ffffff;
        }

        .btn-primary:hover {
            background-color: rgba(0, 51, 102, 1) !important;
            color: #ffffff;
            border-color: #204d74;
            border-radius: 5px;
        }

        .btn.btn-secondary {
            background-color: #fff;
            border: #ccc 1px solid;
            color: #003366;
        }

        .btn-secondary:hover {
            background-color: #f2f2f2;
        }

        .btn-secondary:focus {
            border-color: #ccc;
            box-shadow: 0 0 0 0.2rem #ccc;
        }

        .btn-outline-primary {
            color: #38598a;
            border-color: #38598a;
        }

        .btn-outline-primary:hover {
            color: #fff;
            background-color: #38598a;
            border-color: #38598a;
        }

        .btn-outline-primary:focus {
            color: #38598a;
            border-color: #38598a;
        }

        .btn-outline-primary:focus:hover {
            color: #fff;
            background-color: #38598a;
            border-color: #38598a;
        }

        .btn.btn-primary.sv_prev_btn {
            background-color: #ccc;
            border: #ccc 1px solid;
            color: #000;
            min-width: 120px;
            font-size: 16px;
            border-radius: 5px;
        }

        .btn.btn-primary.sv_prev_btn:hover {
            background-color: #2f567b !important;
            color: #ffffff;
            border-color: #204d74;
            border-radius: 5px;
        }

        .btn-link-offender,
        .btn-create-offender {
            float: right;
            ;
        }

        .table td,
        .table th {
            padding: .75rem;
            vertical-align: top;
            border-top: 1px solid #dee2e6 !important;
        }

        P {
            margin: 0;
        }

        input[type="radio"] {
            margin-left: 10px;
            margin-right: 5px;
        }

        input[type="checkbox"] {
            margin-right: 2px;
        }

        label {
            font-weight: normal;
        }

        .form-control {
            margin-bottom: 10px;
        }

        .required:after {
            content: " *";
            color: red;
        }

        .is-primary-contact:after {
            content: " (Primary)";
        }

        .search-button-container {
            position: relative;
        }

        .search-button {
            position: absolute;
            bottom: 0;
        }

        .is-disabled {
            opacity: 0.6;
            text-decoration: none;
            pointer-events: none;
        }

        .read-only {
            background-color: #eee;
            opacity: 1;
            text-decoration: none;
            pointer-events: none;
        }

        .read-only-checkbox {
            opacity: 1;
            text-decoration: none;
            pointer-events: none;
        }

        .hidden {
            display: none;
        }

        .bc-corrections-info {
            padding-top: 1.8rem;
            padding-bottom: 1rem;
            border-top: 1px solid rgba(0, 0, 0, 0.3);
        }

        .institutional-info {
            padding-top: 1.8rem;
            padding-bottom: 1rem;
            border-top: 1px solid rgba(0, 0, 0, 0.3);
        }

        .community-info {
            padding-top: 1.8rem;
            padding-bottom: 1rem;
            border-top: 1px solid rgba(0, 0, 0, 0.3);
        }

        .loading-indicator {
            border: 16px solid #f3f3f3;
            border-radius: 50%;
            border-top: 16px solid #3498db;
            -webkit-animation: spin 2s linear infinite;
            /* Safari */
            animation: spin 2s linear infinite;

            position: fixed;
            z-index: 999;
            height: 6em;
            width: 6em;
            margin: auto;
            top: 0;
            left: 0;
            bottom: 0;
            right: 0;
        }

        @-webkit-keyframes spin {
            0% {
                -webkit-transform: rotate(0deg);
            }

            100% {
                -webkit-transform: rotate(360deg);
            }
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>

    <div class="loading-indicator hidden"></div>

    <div class="container">
        <!-- search section -->
        <div class="search-container hidden" id="search-container">
            <div class="row mt-4">
                <div class="col">
                    <h2 class="m-0">CORNET Search</h2>
                </div>
                <div class="col">
                    <input type="radio" name="search_type" value="Exact" id="exact" onchange="searchTypeChange('exact')" checked><label for="exact">Exact Search</label>
                    <input type="radio" name="search_type" value="Partial" id="partial" onchange="searchTypeChange('partial')"><label for="partial">Partial Search</label>
                    <input type="radio" name="search_type" value="Soundex" id="soundex" onchange="searchTypeChange('soundex')"><label for="soundex">Soundex Search</label>
                </div>
            </div>

            <div class="row mt-3">
                <div class="col-3">
                    <label for="surname" class="surname required">Surname</label>
                    <br>
                    <input class="form-control surname" type="text" id="surname" name="surname" oninput="surnameChange(this.value)">
                </div>

                <div class="col-3">
                    <label for="given_name" class="given_name">Given name</label>
                    <br>
                    <input class="form-control given_name" type="text" id="given_name" name="given_name" oninput="fieldChange(this.value)">
                </div>

                <div class="col-3">
                    <label for="second_name" class="second_name">Second name</label>
                    <br>
                    <input class="form-control second_name" type="text" id="second_name" name="second_name" oninput="fieldChange(this.value)">
                </div>

                <div class="col-3">
                    <br>
                    <input type="checkbox" class="current_name" id="current_name" name="current_name" onchange="currentNameChange(this.checked)">
                    <label for="current_name" class="current_name">Current Name</label>
                </div>
            </div>

            <div class="row mt-3">
                <div class="col-3">
                    <label for="gender" class="gender">Gender</label>
                    <br>
                    <select class="form-control gender" id="gender" name="gender" oninput="fieldChange(this.value)">
                        <option value=""></option>
                        <option value="M">Male</option>
                        <option value="F">Female</option>
                    </select>
                </div>

                <div class="col-3 d-flex">
                    <div class="col-6 pl-0">
                        <label for="birth_year" class="birth_year">Birth year</label>
                        <br>
                        <input class="form-control birth_year" type="text" id="birth_year" name="birth_year" placeholder="yyyy" oninput="fieldChange(this.value)">
                    </div>

                    <div class="col-6 pr-0">
                        <label for="year_range" class="year_range">Year range</label>
                        <br>
                        <input class="form-control year_range" type="text" id="year_range" name="year_range" placeholder="+/-" oninput="fieldChange(this.value)">
                    </div>
                </div>

                <div class="col-3 d-flex">
                    <div class="col-6 pl-0">
                        <label for="cs" class="cs">CS#</label>
                        <br>
                        <input class="form-control cs" type="text" id="cs" name="cs" oninput="csChange(this.value)">
                    </div>

                    <div class="col-6 pr-0">
                        <label for="fps" class="fps">FPS#</label>
                        <br>
                        <input class="form-control fps" type="text" id="fps" name="fps" oninput="fpsChange(this.value)">
                    </div>
                </div>

                <div class="col-3 search-button-container">
                    <button onclick="search()" class="btn btn-primary search-button" id="search-button">SEARCH</button>
                </div>
            </div>

            <div class="row mt-5 search-results-row hidden">
                <div class="col">
                    <table class="table table-striped" id="client-table">
                        <thead class="thead">
                            <th>Last Name</th>
                            <th>Given Names</th>
                            <th>Current Name</th>
                            <th>Gender</th>
                            <th>Birth date</th>
                            <th>CS#</th>
                            <th>Custody status</th>
                            <th>Actions</th>
                        </thead>

                        <tbody>
                        </tbody>
                    </table>
                </div>

            </div>
        </div>
        <!-- END of search section -->

        <!-- client details section -->
        <div class="client-details-container hidden" id="client-details-container">
            <div class="row">
                <div class="col">
                    <ul class="nav">
                        <li class="nav-item">
                            <a id="tab-subject-info" class="nav-link nav-tab-table active-page" onclick="showTabContent(event, 'subject-information-container')">Subject Information</a>
                        </li>
                        <li class="nav-item">
                            <a id="tab-offences" class="nav-link nav-tab-table" onclick="showTabContent(event, 'offences-container')">Offences</a>
                        </li>
                        <li class="nav-item">
                            <a id="tab-movements" class="nav-link nav-tab-table" onclick="showTabContent(event, 'movements-container')">Movements</a>
                        </li>
                        <li class="nav-item">
                            <a id="tab-hearings" class="nav-link nav-tab-table" onclick="showTabContent(event, 'hearings-container')">Hearings</a>
                        </li>
                        <li class="nav-item">
                            <a id="tab-victim-info" class="nav-link nav-tab-table" onclick="showTabContent(event, 'victim-information-container')">Victim Information</a>
                        </li>
                        <li class="nav-item">
                            <a id="tab-state-transition" class="nav-link nav-tab-table" onclick="showTabContent(event, 'state-transitions-container')">State Transitions</a>
                        </li>
                        <li class="nav-item">
                            <a id="tab-key-dates" class="nav-link nav-tab-table" onclick="showTabContent(event, 'key-dates-container')">Key Dates</a>
                        </li>
                    </ul>
                </div>
            </div>

            <!-- Subject Information section -->
            <div id="subject-information-container">
                <div class="row mt-4">
                    <div class="col">
                        <p><strong>Subject Information</strong></p>
                    </div>
                </div>

                <div class="row">
                    <div class="col-4">
                        <label for="offenderLastName" class="offenderLastName">Last Name</label>
                        <br>
                        <input class="form-control offenderLastName read-only" type="text" id="offenderLastName" name="offenderLastName">
                    </div>
                    <div class="col-4">
                        <label for="offenderGivenNames" class="offenderGivenNames">Given Names</label>
                        <br>
                        <input class="form-control offenderGivenNames read-only" type="text" id="offenderGivenNames" name="offenderGivenNames">
                    </div>
                    <div class="col-4">
                        <br>
                        <input type="checkbox" class="current_name read-only" id="offenderCurrentName" name="offenderCurrentName">
                        <label for="offenderCurrentName" class="offenderCurrentName read-only-checkbox">Current Name</label>
                    </div>
                </div>

                <div class="row">
                    <div class="col-4">
                        <label for="offenderGender" class="offenderGender">Gender</label>
                        <br>
                        <input class="form-control offenderGender read-only" type="text" id="offenderGender" name="offenderGender">
                    </div>
                    <div class="col-4">
                        <label for="offenderBirthdate" class="offenderBirthdate">Birthdate</label>
                        <br>
                        <input class="form-control offenderBirthdate read-only" type="text" id="offenderBirthdate" name="offenderBirthdate">
                    </div>
                    <div class="col-4">
                        <label for="offenderAliases" class="offenderAliases">Alias(es)</label>
                        <br>
                        <input class="form-control offenderAliases read-only" type="text" id="offenderAliases" name="offenderAliases">
                    </div>
                </div>

                <div class="row">
                    <div class="col-4">
                        <label for="offenderCS" class="offenderCS">CS#</label>
                        <br>
                        <input class="form-control offenderCS read-only" type="text" id="offenderCS" name="offenderCS">
                    </div>
                </div>

                <div class="row institutional-info mt-4 mb-4">
                    <div class="col">
                        <p><strong>Institutional Information</strong></p>
                    </div>
                </div>

                <div class="row offender-coast-info hidden">
                    <div class="col-4">
                        <label for="offenderInCustody" class="offenderInCustody read-only-checkbox">In custody?</label>
                        <input type="checkbox" class="offenderInCustody read-only" id="offenderInCustody" name="offenderInCustody">
                    </div>

                    <div class="col-4">
                        <label for="offenderInOut" class="offenderInOut read-only-checkbox">In/Out?</label>
                        <input type="checkbox" class="offenderInOut read-only" id="offenderInOut" name="offenderInOut">
                    </div>

                    <div class="col-4">
                        <label for="offenderIntermittentSentence" class="offenderIntermittentSentence read-only-checkbox">Intermittent sentence?</label>
                        <input type="checkbox" class="offenderIntermittentSentence read-only" id="offenderIntermittentSentence" name="offenderIntermittentSentence">
                    </div>
                </div>

                <div class="row key-date-container flex-container" id="key-dates">
                    <div class="col-4 custody-location hidden">
                        <label for="offenderCustodyLocation" class="offenderCustodyLocation">Custody Location</label>
                        <br>
                        <input class="form-control offenderCustodyLocation read-only" type="text" id="offenderCustodyLocation" name="offenderCustodyLocation">
                    </div>
                </div>

                <div class="row more-key-date-container flex-container hidden" id="more-key-dates">

                </div>

                <div class="row community-info offender-coast-info hidden mt-4">
                    <div class="col">
                        <p><strong>Community Information</strong></p>
                    </div>
                </div>

                <div class="row offender-coast-info hidden">
                    <div class="col-4 community-location hidden">
                        <label for="offenderCommunityLocation" class="offenderCommunityLocation">Community Location</label>
                        <br>
                        <input class="form-control offenderCommunityLocation read-only" type="text" id="offenderCommunityLocation" name="offenderCommunityLocation">
                    </div>

                    <div class="col-4">
                        <label for="offenderCommunityStatus" class="offenderCommunityStatus read-only-checkbox">Community Status</label>
                        <input type="checkbox" class="offenderCommunityStatus read-only" id="offenderCommunityStatus" name="offenderCommunityStatus">
                    </div>

                    <div class="col-4">
                        <label for="offenderAWOL" class="offenderAWOL read-only-checkbox">AWOL?</label>
                        <input type="checkbox" class="offenderAWOL read-only" id="offenderAWOL" name="offenderAWOL">
                    </div>
                </div>

                <div class="row offender-coast-info hidden mt-4">
                    <div class="col-4">
                        <label for="offenderProbationOfficer" class="offenderProbationOfficer">Probation officer / bail supervisor</label>
                        <br>
                        <input class="form-control offenderProbationOfficer read-only" type="text" id="offenderProbationOfficer" name="offenderProbationOfficer">
                    </div>

                    <div class="col-4">
                        <br>
                        <label for="offenderReportingOrder" class="offenderReportingOrder read-only-checkbox">Reporting Order?</label>
                        <input type="checkbox" class="offenderReportingOrder read-only" id="offenderReportingOrder" name="offenderReportingOrder">
                    </div>

                    <div class="col-4">
                        <label for="offenderPoliceFileNumber" class="offenderPoliceFileNumber">Police File Number</label>
                        <br>
                        <input class="form-control offenderPoliceFileNumber read-only" type="text" id="offenderPoliceFileNumber" name="offenderPoliceFileNumber">
                    </div>
                </div>
            </div>
            <!-- END of Subject Information section -->

            <div id="offences-container" class="hidden">
                <div class="row mt-4">
                    <div class="col">
                        <p><strong>Offences</strong></p>
                    </div>
                </div>
                <div class="row">
                    <div class="col">
                        <table class="table table-striped" id="offences-table">
                            <thead class="thead">
                                <th>File #</th>
                                <th>Count #</th>
                                <th>Court Location</th>
                                <th>Act</th>
                                <th>Section</th>
                                <th>Sub.</th>
                                <th>Description</th>
                                <th>Doc. Type</th>
                                <th>Expiry</th>
                            </thead>

                            <tbody>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="row mt-4 load-more-offences-row">
                    <div class="col" id="load-more-offences">
                        <button onclick="loadMoreOffencesClick()" class="btn btn-secondary btn-load-more-offences">Load More</button>
                    </div>
                </div>

                <div class="more-offences-container hidden">
                    <div class="row mt-4">
                        <div class="col">
                            <p><strong>Additional Offences</strong></p>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col">
                            <table class="table table-striped" id="more-offences-table">
                                <thead class="thead">
                                    <th>File #</th>
                                    <th>Count #</th>
                                    <th>Court Location</th>
                                    <th>Act</th>
                                    <th>Section</th>
                                    <th>Sub.</th>
                                    <th>Description</th>
                                    <th>Doc. Type</th>
                                    <th>Expiry</th>
                                </thead>

                                <tbody>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="no-more-offences hidden">
                    <div class="row mt-4">
                        <div class="col">
                            <p><strong>No Additional Offences</strong></p>
                        </div>
                    </div>
                </div>
            </div>

            <div id="movements-container" class="hidden">
                <div class="row mt-4">
                    <div class="col">
                        <p><strong>Movements</strong></p>
                    </div>
                </div>
                <div class="row">
                    <div class="col">
                        <table class="table table-striped" id="movements-table">
                            <thead class="thead">
                                <th>Date</th>
                                <th>Time</th>
                                <th>Type</th>
                                <th>In/Out</th>
                                <th>Movement Reason</th>
                                <th>To</th>
                                <th>Comment</th>
                            </thead>

                            <tbody>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="row mt-4 load-more-movements-row">
                    <div class="col" id="load-more-movements">
                        <button onclick="loadMoreMovementsClick()" class="btn btn-secondary btn-load-more-movements">Load More</button>
                    </div>
                </div>

                <div class="more-movements-container hidden">
                    <div class="row mt-4">
                        <div class="col">
                            <p><strong>Additional Movements</strong></p>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col">
                            <table class="table table-striped" id="more-movements-table">
                                <thead class="thead">
                                    <th>Date</th>
                                    <th>Time</th>
                                    <th>Type</th>
                                    <th>In/Out</th>
                                    <th>Movement Reason</th>
                                    <th>To</th>
                                    <th>Comment</th>
                                </thead>

                                <tbody>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="no-more-movements hidden">
                    <div class="row mt-4">
                        <div class="col">
                            <p><strong>No Additional Movements</strong></p>
                        </div>
                    </div>
                </div>
            </div>

            <div id="hearings-container" class="hidden">
                <div class="row mt-4">
                    <div class="col">
                        <p><strong>Hearings</strong></p>
                    </div>
                </div>
                <div class="row">
                    <div class="col">
                        <table class="table table-striped" id="hearings-table">
                            <thead class="thead">
                                <th>Date</th>
                                <th>Hearing Purpose</th>
                                <th>Hearing Scheduled Date</th>
                                <th>Hearing Type Description</th>
                                <th>Hearing Purpose Type Description</th>
                                <th>Hearing Outcome Type Description</th>
                            </thead>

                            <tbody>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="row mt-4 load-more-hearings-row">
                    <div class="col" id="load-more-hearings">
                        <button onclick="loadMoreHearingsClick()" class="btn btn-secondary btn-load-more-hearings">Load More</button>
                    </div>
                </div>

                <div class="more-hearings-container hidden">
                    <div class="row mt-4">
                        <div class="col">
                            <p><strong>Additional Hearings</strong></p>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col">
                            <table class="table table-striped" id="more-hearings-table">
                                <thead class="thead">
                                    <th>Date</th>
                                    <th>Hearing Purpose</th>
                                    <th>Hearing Scheduled Date</th>
                                    <th>Hearing Type Description</th>
                                    <th>Hearing Purpose Type Description</th>
                                    <th>Hearing Outcome Type Description</th>
                                </thead>

                                <tbody>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="no-more-hearings hidden">
                    <div class="row mt-4">
                        <div class="col">
                            <p><strong>No Additional Hearings</strong></p>
                        </div>
                    </div>
                </div>
            </div>

            <div id="victim-information-container" class="hidden">
                <div class="row mt-4">
                    <div class="col">
                        <p><strong>Victim Information</strong></p>
                    </div>
                </div>
                <div class="row">
                    <div class="col">
                        <table class="table table-striped" id="victim-information-table">
                            <thead class="thead">
                                <th>Name</th>
                                <th>Relationship</th>
                                <th>View Victim Details</th>
                            </thead>

                            <tbody>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="row mt-4 load-more-victims-row">
                    <div class="col" id="load-more-victims">
                        <button onclick="loadMoreVictimsClick()" class="btn btn-secondary btn-load-more-victims">Load More</button>
                    </div>
                </div>

                <div class="more-victims-container hidden">
                    <div class="row mt-4">
                        <div class="col">
                            <p><strong>Additional Victim Information</strong></p>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col">
                            <table class="table table-striped" id="more-victim-information-table">
                                <thead class="thead">
                                    <th>Name</th>
                                    <th>Relationship</th>
                                    <th>View Victim Details</th>
                                </thead>

                                <tbody>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="no-more-victims hidden">
                    <div class="row mt-4">
                        <div class="col">
                            <p><strong>No Additional Victim Information</strong></p>
                        </div>
                    </div>
                </div>

                <div class="victim-details-container hidden">
                    <div class="row">
                        <div class="col">
                            <label>Victim Details</label>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-6">
                            <label for="victimName" class="victimName">Name</label>
                            <br>
                            <input class="form-control victimName read-only" type="text" id="victimName" name="victimName">
                        </div>

                        <div class="col-6">
                            <label for="victimComment" class="victimComment">Comment</label>
                            <br>
                            <input class="form-control victimComment read-only" type="text" id="victimComment" name="victimComment">
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-3">
                            <label for="victimEffectiveDate" class="victimEffectiveDate">Effective Date</label>
                            <br>
                            <input class="form-control victimEffectiveDate read-only" type="text" id="victimEffectiveDate" name="victimEffectiveDate">
                        </div>

                        <div class="col-3">
                            <label for="victimExpiryDate" class="victimExpiryDate">Expiry Date</label>
                            <br>
                            <input class="form-control victimExpiryDate read-only" type="text" id="victimExpiryDate" name="victimExpiryDate">
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-6">
                            <label for="victimPrimaryAddress" class="victimPrimaryAddress">Primary Address</label>
                            <br>
                            <input class="form-control victimPrimaryAddress read-only" type="text" id="victimPrimaryAddress" name="victimPrimaryAddress">
                        </div>

                        <div class="col-6">
                            <label for="victimSecondaryAddress" class="victimSecondaryAddress">Secondary Address</label>
                            <br>
                            <input class="form-control victimSecondaryAddress read-only" type="text" id="victimSecondaryAddress" name="victimSecondaryAddress">
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-6">
                            <label for="victimMailingAddress" class="victimMailingAddress">Mailing Address</label>
                            <br>
                            <input class="form-control victimMailingAddress read-only" type="text" id="victimMailingAddress" name="victimMailingAddress">
                        </div>

                        <div class="col-6">
                            <label for="victimBusinessAddress" class="victimBusinessAddress">Business Address</label>
                            <br>
                            <input class="form-control victimBusinessAddress read-only" type="text" id="victimBusinessAddress" name="victimBusinessAddress">
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-4">
                            <label for="victimTelephone" class="victimTelephone">Telephone</label>
                            <br>
                            <input class="form-control victimTelephone read-only" type="text" id="victimTelephone" name="victimTelephone">
                        </div>

                        <div class="col-4">
                            <label for="victimMobile" class="victimMobile">Mobile</label>
                            <br>
                            <input class="form-control victimMobile read-only" type="text" id="victimMobile" name="victimMobile">
                        </div>

                        <div class="col-4">
                            <label for="victimEmail" class="victimEmail">Email</label>
                            <br>
                            <input class="form-control victimEmail read-only" type="text" id="victimEmail" name="victimEmail">
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-4">
                            <label for="victimTelephoneEffectiveDate" class="victimTelephoneEffectiveDate">Effective Date</label>
                            <br>
                            <input class="form-control victimTelephoneEffectiveDate read-only" type="text" id="victimTelephoneEffectiveDate" name="victimTelephoneEffectiveDate">
                        </div>

                        <div class="col-4">
                            <label for="victimMobileEffectiveDate" class="victimMobileEffectiveDate">Effective Date</label>
                            <br>
                            <input class="form-control victimMobileEffectiveDate read-only" type="text" id="victimMobileEffectiveDate" name="victimMobileEffectiveDate">
                        </div>

                        <div class="col-4">
                            <label for="victimEmailEffectiveDate" class="victimEmailEffectiveDate">Effective Date</label>
                            <br>
                            <input class="form-control victimEmailEffectiveDate read-only" type="text" id="victimEmailEffectiveDate" name="victimEmailEffectiveDate">
                        </div>
                    </div>
                </div>
            </div>

            <div id="state-transitions-container" class="hidden">
                <div class="row mt-4">
                    <div class="col">
                        <p><strong>State Transitions</strong></p>
                    </div>
                </div>
                <div class="row">
                    <div class="col">
                        <table class="table table-striped" id="state-transitions-table">
                            <thead class="thead">
                                <th>Date</th>
                                <th>Type</th>
                                <th>Sub-Type</th>
                                <th>Description</th>
                            </thead>

                            <tbody>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="row mt-4 load-more-state-transitions-row">
                    <div class="col" id="load-more-state-transitions">
                        <button onclick="loadMoreStateTransitionsClick()" class="btn btn-secondary btn-load-more-state-transitions">Load More</button>
                    </div>
                </div>

                <div class="more-state-transitions-container hidden">
                    <div class="row mt-4">
                        <div class="col">
                            <p><strong>Additional State Transitions</strong></p>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col">
                            <table class="table table-striped" id="more-state-transitions-table">
                                <thead class="thead">
                                    <th>Date</th>
                                    <th>Type</th>
                                    <th>Sub-Type</th>
                                    <th>Description</th>
                                </thead>

                                <tbody>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="no-more-state-transitions hidden">
                    <div class="row mt-4">
                        <div class="col">
                            <p><strong>No Additional State Transitions</strong></p>
                        </div>
                    </div>
                </div>
            </div>

            <div id="key-dates-container" class="hidden">
                <div class="row mt-4">
                    <div class="col">
                        <p><strong>Key Dates</strong></p>
                    </div>
                </div>
                <div class="row">
                    <div class="col">
                        <table class="table table-striped" id="key-dates-table">
                            <thead class="thead">
                                <th>Date</th>
                                <th>Activity Description</th>
                                <th>Key Date Type Code</th>
                                <th>Sentence Type Code </th>
                                <th>Description</th>
                            </thead>

                            <tbody>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="row mt-4 load-more-key-dates-row">
                    <div class="col" id="load-more-key-dates">
                        <button onclick="loadMoreKeyDatesClick()" class="btn btn-secondary btn-load-more-key-dates">Load More</button>
                    </div>
                </div>

                <div class="more-key-dates-container hidden">
                    <div class="row mt-4">
                        <div class="col">
                            <p><strong>Additional Key Dates</strong></p>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col">
                            <table class="table table-striped" id="more-key-dates-table">
                                <thead class="thead">
                                    <th>Date</th>
                                    <th>Activity Description</th>
                                    <th>Key Date Type Code</th>
                                    <th>Sentence Type Code </th>
                                    <th>Description</th>
                                </thead>

                                <tbody>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="no-more-key-dates hidden">
                    <div class="row mt-4">
                        <div class="col">
                            <p><strong>No Additional Key Dates</strong></p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row mt-5">
                <div class="col hidden" id="return-to-search">
                    <button onclick="clearOffenderDetails(); showSearch();" class="btn btn-secondary">Return to Search</button>
                </div>
                <div class="col hidden" id="link-offender">
                    <button onclick="linkOffenderClick()" class="btn btn-secondary btn-link-offender">Link</button>
                </div>
            </div>
        </div>
        <!-- END of client details section -->
    </div>

    <script>
        //global constants
        const OffenderButtonStatus = {
            SHOW_LINK: 0,
            SHOW_CREATE: 1,
            NONE: 2
        }

        const FormTypes = {
            OFFENDER: 0,
            SUBJECT: 1,
            OTHER: 2,
            NONE: 3
        }

        const TABS = [
            "subject-information-container",
            "offences-container",
            "movements-container",
            "hearings-container",
            "victim-information-container",
            "state-transitions-container",
            "key-dates-container",
        ];

        const GenderOptionSet = {
            Male: { val: 100000000, name: "M" },
            Female: { val: 100000001, name: "F" },
            X: { val: 100000002, name: "X" },
        };

        const CRMBoolean = {
            True: 100000001,
            False: 100000000,
        }

        const CommunityStatus = {
            Active: 100000000,
            Inactive: 100000001,
        }

        const EventType = {
            KEY_DATE: { val: 100000000, name: "KEY_DATE" },
            MOVEMENT: { val: 100000001, name: "MOVEMENT" },
            HEARING: { val: 100000002, name: "HEARING" },
            STATE_TRAN: { val: 100000003, name: "STATE_TRAN" },
            VICT_CNTCT: { val: 100000004, name: "VICT_CNTCT" },
            AUTH_DOCM: { val: 100000005, name: "AUTH_DOCM" },
        };

        const OffenderIdType = {
            ID: 0,
            CS_NUMBER: 1
        }

        const StatusCode = {
            Active: 1,
            Inactive: 2,
        }

        const StateCode = {
            Active: 0,
            Inactive: 1,
        }

        const OffenderDetailsFields = [
            "offenderLastName",
            "offenderGivenNames",
            "offenderGender",
            "offenderBirthdate",
            "offenderAliases",
            "offenderCS",
            "offenderCustodyLocation",
            "offenderCommunityLocation",
            "offenderProbationOfficer",
            "offenderPoliceFileNumber",
        ];
        const OffenderDetailsCheckboxes = [
            "offenderCurrentName",
            "offenderInCustody",
            "offenderInOut",
            "offenderIntermittentSentence",
            "offenderCommunityStatus",
            "offenderAWOL",
            "offenderReportingOrder",
        ];
        const VictimDetailsFields = [
            "victimName",
            "victimComment",
            "victimEffectiveDate",
            "victimExpiryDate",
            "victimPrimaryAddress",
            "victimSecondaryAddress",
            "victimMailingAddress",
            "victimBusinessAddress",
            "victimTelephone",
            "victimTelephoneEffectiveDate",
            "victimMobile",
            "victimMobileEffectiveDate",
            "victimEmail",
            "victimEmailEffectiveDate",
        ];

        //number of search table rows to show at a time, paginated table
        const ROWS_SHOWN = 5;

        //CRM form the webresource is hosted in
        //if on the Offender form we need to either show search + Link ability, or we just show the already linked details
        //if on the Subject form we need to either show search + Create/Link ability, or we just show the already linked details
        let FORM_TYPE = FormTypes.NONE;

        //flag to track if the offender details loaded is for a CS# that already exists in COAST
        let OFFENDER_EXISTS_IN_COAST = false;

        //search results from cornet
        let clients = [];
        let displayed_clients = [];
        let filter_on_current_name = false;

        //variables to hold client details info and cornet event info
        let client_details = {};
        let coastInfo = {};
        let events = [];
        let offences = [];
        let movements = [];
        let hearings = [];
        let victim_information = [];
        let state_transitions = [];
        let key_dates = [];
        let more_offences = [];
        let more_movements = [];
        let more_hearings = [];
        let more_victim_information = [];
        let more_state_transitions = [];
        let more_key_dates = [];

        //var to show how many cornet notifications returned no content - for debuggind
        let no_content = [];

        window.onload = function () {
            initPaginator();
            this.search_type = "exact";
            disableSearchButton();

            let entity = parent.Xrm.Page.data.entity.getEntityName();
            if (entity == "vsd_offender") {
                //if this offender has CS Number (that is: it is linked to a cornet client already)
                //-> then show the client details - no search ability
                //if there is no CS Number (not already linked)
                //-> then default to search and has link ability
                FORM_TYPE = FormTypes.OFFENDER;
                let cs_number = parent.Xrm.Page.getAttribute("vsd_csnumber").getValue();

                if (cs_number) {
                    OFFENDER_EXISTS_IN_COAST = true;
                    showOffender(cs_number);
                }
                else {
                    showLinkOffenderButton();
                    showReturnToSearchButton();
                    showSearch();

                    let surname = parent.Xrm.Page.getAttribute("vsd_lastname").getValue();
                    let given_names = parent.Xrm.Page.getAttribute("vsd_firstname").getValue();
                    let first = "";
                    let second = "";
                    if (given_names) {
                        first = given_names.split(' ')[0] || "";
                        second = given_names.split(' ')[1] || "";
                    }
                    let gender = parent.Xrm.Page.getAttribute("vsd_gender").getValue();
                    if (gender) {
                        let opt = getOptionsSetVal(GenderOptionSet, gender);
                        gender = opt.name;
                    }
                    let birth_year = parent.Xrm.Page.getAttribute("vsd_birthdate").getValue();
                    if (birth_year) {
                        birth_year = birth_year.getFullYear();
                    }
                    $('#surname').val(surname);
                    $('#given_name').val(first);
                    $('#second_name').val(second);
                    $('#gender').val(gender);
                    $('#birth_year').val(birth_year);

                    if (surname) {
                        enableSearchButton();
                        search();
                    }
                }
            }
            else if (entity == "vsd_caseoffender") {
                FORM_TYPE = FormTypes.SUBJECT;
                let offender = parent.Xrm.Page.getAttribute("vsd_offender").getValue();
                let cs_number = "";
                if (offender && offender.length > 0 && offender[0].name) {
                    cs_number = offender[0].name;
                }

                if (cs_number) {
                    OFFENDER_EXISTS_IN_COAST = true;
                    showOffender(cs_number);
                }
                else {
                    showReturnToSearchButton();
                    showLinkOffenderButton();
                    showSearch();
                }
            }
            else {
                FORM_TYPE = FormTypes.OTHER;
                showReturnToSearchButton();
                showSearch();
            }
        };

        function search() {
            showLoadingSpinner();
            let parameters = {
                SearchType: this.search_type,
                Surname: $('#surname').val(),
                Given1: $('#given_name').val(),
                Given2: $('#second_name').val(),
                Gender: $('#gender').val(),
                BirthYear: $('#birth_year').val(),
                BirthYearRange: $('#year_range').val(),

                UserName: "test",
                FullName: "test",
                Client: "test",
            };

            let type = "";
            let text = "";
            let cs = $('#cs').val();
            let fps = $('#fps').val();

            if (cs) {
                type = "CSNO";
                text = cs;
                parameters.SearchType = "ID";
            }
            else if (fps) {
                type = "FPS";
                text = cs;
                parameters.SearchType = "ID";
            }

            if (type) parameters.IdentifierType = type;
            if (text) parameters.IdentifierText = text;

            var myHeaders = new Headers();
            myHeaders.append("Content-Type", "application/json");

            var requestOptions = {
                method: 'POST',
                headers: myHeaders,
                body: JSON.stringify(parameters),
                credentials: "same-origin"
            };

            let endpoint = parent.Xrm.Page.context.getClientUrl();
            endpoint += "/api/data/v9.0/vsd_CORNETOffenderSearch";

            fetch(endpoint, requestOptions)
                .then(response => response.text())
                .then(res => {
                    hideLoadingSpinner();
                    let parsed = JSON.parse(res);
                    if (parsed && parsed.Result) {
                        if ((!parsed.IsSuccess) || parsed.Result.includes("No Content")) {
                            //remove any old rows in the table and remove the paginator
                            emptySearchResultsTable();
                            let nav = $("#nav");
                            if (nav) nav.remove();
                            return;
                        }
                        let data = JSON.parse(parsed.Result);
                        addResultsToSearchTable(data.clients);
                    }
                })
                .catch(error => {
                    alert("Encountered an issue getting search results");
                    hideLoadingSpinner();
                    console.log('error', error);
                });
        }

        function addResultsToSearchTable(clients) {
            if (filter_on_current_name) {
                displayed_clients = clients.filter(c => c.isCurrentName == 'Y');
            }
            else {
                displayed_clients = clients;
            }

            //make sure table shows and any previously existing rows are removed
            $(".search-results-row").removeClass("hidden");
            emptySearchResultsTable();

            displayed_clients.forEach((client, i) => {
                let tr = `<tr>
                    <td>${client.personName.split(',')[0]}</td>
                    <td>${client.personName.split(',').splice(1).join(',')}</td>
                    <td>${client.isCurrentName == 'Y' ? '<i class="far fa-check-circle"></i>' : ''}</td>
                    <td>${client.personGenderIdentityCodeType || ''}</td>
                    <td>${client.personBirthDate || ''}</td>
                    <td>${client.clientNumber || ''}</td>
                    <td>${client.locationTypeCode.custody || ''}</td>
                    <td>${client.clientNumber ? '<button onclick="viewOffenderClick(' + i + ')" class="btn btn-secondary">View</button>' : ''}</td>
                    
                    </tr>`;
                $("#client-table").append(tr);
            });
            initPaginator();
        }

        function initPaginator() {
            //if existing paginator, remove the old one
            let nav = $("#nav");
            if (nav) nav.remove();

            $('#client-table').after('<div id="nav"></div>');
            var rowsShown = ROWS_SHOWN;
            var rowsTotal = $('#client-table tbody tr').length;
            var numPages = rowsTotal / rowsShown;
            for (i = 0; i < numPages; i++) {
                var pageNum = i + 1;
                $('#nav').append('<a href="#" rel="' + i + '">' + pageNum + '</a> ');
            }
            $('#client-table tbody tr').hide();
            $('#client-table tbody tr').slice(0, rowsShown).show();
            $('#nav a:first').addClass('active');
            $('#nav a').bind('click', function () {

                $('#nav a').removeClass('active');
                $(this).addClass('active');
                var currPage = $(this).attr('rel');
                var startItem = currPage * rowsShown;
                var endItem = startItem + rowsShown;
                $('#client-table tbody tr').css('opacity', '0.0').hide().slice(startItem, endItem).css('display', 'table-row').animate({ opacity: 1 }, 300);
            });
        }

        function searchTypeChange(val) {
            this.search_type = val;
            if (val === "exact") {
                $(".given_name").removeClass("is-disabled");
                $(".second_name").removeClass("is-disabled");
                $(".current_name").removeClass("is-disabled");
                $(".current_name_label").removeClass("is-disabled");
                $(".gender").removeClass("is-disabled");
                $(".birth_year").removeClass("is-disabled");
                $(".year_range").removeClass("is-disabled");
            }
            else if (val === "partial" || val === "soundex") {
                $(".given_name").val("");
                $(".second_name").val("");
                $(".current_name").val("");
                $(".gender").val("");
                $(".birth_year").val("");
                $(".year_range").val("");

                $(".given_name").addClass("is-disabled");
                $(".second_name").addClass("is-disabled");
                $(".current_name").addClass("is-disabled");
                $(".current_name_label").addClass("is-disabled");
                $(".gender").addClass("is-disabled");
                $(".birth_year").addClass("is-disabled");
                $(".year_range").addClass("is-disabled");
            }
        }

        function surnameChange(val) {
            if (val) {
                enableSearchButton();
                $("#cs").val("");
                $("#fps").val("");
            }
            else {
                disableSearchButton();
            }
        }

        function fieldChange(val) {
            if (val) {
                $("#cs").val("");
                $("#fps").val("");
            }
        }

        function csChange(val) {
            if (val) {
                enableSearchButton();
                $("#surname").val("");
                $("#given_name").val("");
                $("#second_name").val("");
                $("#gender").val("");
                $("#birth_year").val("");
                $("#year_range").val("");
                $("#fps").val("");
            }
            else {
                disableSearchButton();
            }
        }

        function fpsChange(val) {
            if (val) {
                enableSearchButton();
                $("#surname").val("");
                $("#given_name").val("");
                $("#second_name").val("");
                $("#gender").val("");
                $("#birth_year").val("");
                $("#year_range").val("");
                $("#cs").val("");
            }
            else {
                disableSearchButton();
            }
        }

        function currentNameChange(val) {
            filter_on_current_name = val;
            addResultsToSearchTable(clients);
        }

        function viewOffenderClick(val) {
            let cs_number = displayed_clients[val].clientNumber;
            showOffender(cs_number);
        }

        function showOffender(cs_number) {
            scrollPageToTop();
            hideSearchSection();
            showClientDetailsSection();

            loadOffender(cs_number, OffenderIdType.CS_NUMBER);
        }

        function showSearch() {
            scrollPageToTop();
            showSearchSection();
            hideClientDetailsSection();
        }

        //get and combine info from cornet and crm
        function loadOffender(id, id_type) {
            showLoadingSpinner();

            client_details = {};
            coastInfo = {};
            events = [];
            offences = [];
            movements = [];
            hearings = [];
            victim_information = [];
            state_transitions = [];
            key_dates = [];
            more_offences = [];
            more_movements = [];
            more_hearings = [];
            more_victim_information = [];
            more_state_transitions = [];
            more_key_dates = [];

            getCOASTOffender(id, id_type).then(offender => {
                let promise_array = [];
                let cs_number = "";
                if (id_type === OffenderIdType.CS_NUMBER) {
                    cs_number = id;
                }
                if (!$.isEmptyObject(offender)) {
                    OFFENDER_EXISTS_IN_COAST = true;
                    coastInfo = offender;
                    cs_number = offender.vsd_csnumber;


                    if (FORM_TYPE === FormTypes.OFFENDER) {
                        disableLinkOffenderButton();
                    }
                    if (FORM_TYPE === FormTypes.SUBJECT) {
                        //check if this offender is linked to any other subject
                        isOffenderAlreadyLinkedToSubject().then((already_linked) => {
                            if (already_linked) {
                                disableLinkOffenderButton();
                            }
                        });
                    }
                    //TODO - add something to indicate the the reason the button is disabled is because this cornet offender already exists in COAST
                }
                else {
                    OFFENDER_EXISTS_IN_COAST = false;
                }

                if (cs_number) {
                    promise_array.push(new Promise((resolve, reject) => {
                        getNotificationsForOffender(cs_number).then(() => {
                            resolve();
                        });
                    }));

                    promise_array.push(new Promise((resolve, reject) => {
                        loadCornetOffender(cs_number).then(res => {
                            client_details = res.find(o => o.isCurrentName === "Y");
                            if (res.length > 1) {
                                let aliases = res.filter(c => c.isCurrentName == "N");
                                client_details.aliases = aliases.map(a => a.personName.replace(/,/g, '')).join(', ');
                                client_details.aliasesForCRM = aliases.map(a => (a.personName + " - " + a.personBirthDate)).join('\n');
                            }

                            let curr_client = res.find(c => c.isCurrentName == "Y");
                            Object.assign(client_details, curr_client);
                            client_details.lastName = client_details.personName.split(',')[0];
                            client_details.givenNames = client_details.personName.split(',').splice(1).join(',');
                            if (!$.isEmptyObject(coastInfo)) {
                                client_details.coastInfo = coastInfo;
                            }
                            populateSubjectInformation();
                            resolve();
                        }).catch((err) => {
                            alert("Encountered an issue loading information");
                            hideLoadingSpinner();
                            reject(err);
                        });
                    }));
                }
                else {
                    hideLoadingSpinner();
                }

                Promise.all(promise_array).then((res) => {
                    hideLoadingSpinner();
                }).catch((err) => {
                    hideLoadingSpinner();
                    alert("Error retrieving subject information.");
                });
            });
        }

        function loadCornetOffender(cs_number) {
            return new Promise((resolve, reject) => {
                let parameters = {
                    SearchType: "ID",
                    IdentifierType: "CSNO",
                    IdentifierText: cs_number,

                    UserName: "test",
                    FullName: "test",
                    Client: "test",
                };

                var myHeaders = new Headers();
                myHeaders.append("Content-Type", "application/json");

                var requestOptions = {
                    method: 'POST',
                    headers: myHeaders,
                    body: JSON.stringify(parameters),
                    credentials: "same-origin"
                };

                let endpoint = parent.Xrm.Page.context.getClientUrl();
                endpoint += "/api/data/v9.0/vsd_CORNETOffenderSearch";

                fetch(endpoint, requestOptions)
                    .then(response => response.text())
                    .then(res => {
                        let parsed = JSON.parse(res);
                        if (parsed && parsed.Result) {
                            let data = JSON.parse(parsed.Result);
                            resolve(data.clients);
                        }
                        else {
                            resolve([]);
                        }
                    })
                    .catch(err => {
                        alert("Encountered an issue loading information");
                        hideLoadingSpinner();
                        console.log('error', err)
                        reject(err);
                    });
            }).catch(err => {
                hideLoadingSpinner();
                reject(err);
            });
        }

        function getCOASTOffender(id, id_type) {
            return new Promise((resolve, reject) => {
                var myHeaders = new Headers();
                myHeaders.append("Content-Type", "application/json");

                var requestOptions = {
                    method: 'GET',
                    headers: myHeaders,
                    credentials: "same-origin"
                };

                let endpoint = parent.Xrm.Page.context.getClientUrl();
                if (id_type === OffenderIdType.ID) {
                    endpoint += `/api/data/v9.0/vsd_offenders?$filter=vsd_offenderid eq '${id}'`;
                }
                else if (id_type === OffenderIdType.CS_NUMBER) {
                    endpoint += `/api/data/v9.0/vsd_offenders?$filter=vsd_csnumber eq '${id}'`;
                }
                else {
                    resolve({});
                }

                fetch(endpoint, requestOptions)
                    .then(response => response.text())
                    .then(res => {
                        let data = JSON.parse(res);
                        if (data && data.value && data.value.length > 0) {
                            resolve(data.value[0]);
                        }
                        else {
                            resolve({});
                        }
                    })
                    .catch(error => {
                        alert("Encountered an issue loading information");
                        hideLoadingSpinner();
                        console.log('error', error);
                        reject(error);
                    });
            }).catch(err => {
                hideLoadingSpinner();
                reject(err);
            });
        }

        //get all cornet notifications in coast for this cs number
        function getNotificationsForOffender(cs_number) {
            return new Promise((resolve, reject) => {
                var myHeaders = new Headers();
                myHeaders.append("Content-Type", "application/json");

                var requestOptions = {
                    method: 'GET',
                    headers: myHeaders,
                    credentials: "same-origin"
                };

                let endpoint = parent.Xrm.Page.context.getClientUrl();
                endpoint += `/api/data/v9.0/vsd_cornetnotifications?$filter=statecode eq 0 and vsd_clientnumber eq '${cs_number}'`;

                fetch(endpoint, requestOptions)
                    .then(response => response.text())
                    .then(res => {
                        let data = JSON.parse(res);
                        if (data && data.value && data.value.length > 0) {
                            events = data.value;
                            loadCornetEvents().then(() => {
                                resolve();
                            });
                        }
                        else {
                            resolve();
                        }
                    })
                    .catch(error => {
                        alert("Encountered an issue loading notification information");
                        hideLoadingSpinner();
                        console.log('error', error);
                        reject(error);
                    });
            });
        }

        //for each cornet notification found in CRM we need to load the cornet details
        function loadCornetEvents() {
            return new Promise((resolve, reject) => {
                let promise_array = [];
                no_content = [];

                let duplicates = events.filter((e1, index, self) => self.findIndex(e2 => e1.vsd_eventreferenceid == e2.vsd_eventreferenceid && e1.vsd_guid == e2.vsd_guid) != index);
                let guids = {};
                events.forEach(e => {
                    if (guids[e.vsd_guid]) ++guids[e.vsd_guid];
                    else guids[e.vsd_guid] = 1;
                });

                //some events can share vsd_eventreferenceid's, this is expected if an event gets updated it creates a second entry
                //in that case we only want to show that event once, so we filter unique vsd_eventreferenceid's
                events = events.filter((e1, index, self) => self.findIndex(e2 => (e1.vsd_eventreferenceid == e2.vsd_eventreferenceid)) === index);

                //this will filter out events that might have duplicate guids, but this shouldn't happen. Leaving them in so testers can see duplicates (if they exist...)
                // events.filter((e1, index, self) => self.findIndex(e2 => (e1.vsd_guid === e2.vsd_guid && e1.vsd_eventreferenceid !== e2.vsd_eventreferenceid)) !== index);

                if (duplicates.length > 0) {
                    console.log("duplicate cornet notifications:");
                    console.log(duplicates);
                }

                let duplicateGUIDS = [];
                for (let g in guids) {
                    if (guids[g] > 1) duplicateGUIDS.push(g);
                }

                if (duplicateGUIDS.length > 0) {
                    console.log("duplicate GUIDS:");
                    console.log(duplicateGUIDS);
                }

                for (let i = 0; i < events.length; ++i) {
                    let event = events[i];
                    let event_type = getOptionsSetVal(EventType, event.vsd_eventtype);

                    let parameters = {
                        EventId: event.vsd_eventreferenceid,
                        Guid: event.vsd_guid,

                        UserName: "test",
                        FullName: "test",
                        Client: "test",
                    };

                    switch (event_type) {
                        case EventType.AUTH_DOCM: {
                            promise_array.push(new Promise((resolve, reject) => {
                                parameters.EventType = EventType.AUTH_DOCM.val;
                                parameters.Id = "authority_document_id";

                                getEvent(parameters).then(res => {
                                    if (res) {
                                        res.expiryDateVal = '';
                                        if (res.expiryDate != null) res.expiryDateVal = new Date(res.expiryDate);
                                        offences.push(res);
                                    }
                                    resolve();
                                });
                            }));
                            break;
                        }
                        case EventType.HEARING: {
                            promise_array.push(new Promise((resolve, reject) => {
                                parameters.EventType = EventType.HEARING.val;
                                parameters.Id = "hearing_id";

                                getEvent(parameters).then(res => {
                                    if (res) {
                                        res.activityDate.actualVal = '';
                                        res.activityDate.scheduledVal = '';
                                        if (res.activityDate.actual != null) res.activityDate.actualVal = new Date(res.activityDate.actual.slice(0, 10) + "T00:00:00");
                                        if (res.activityDate.scheduled != null) res.activityDate.scheduledVal = new Date(res.activityDate.scheduled.slice(0, 10) + "T00:00:00");
                                        hearings.push(res);
                                    }
                                    resolve();
                                });
                            }));
                            break;
                        }
                        case EventType.KEY_DATE: {
                            promise_array.push(new Promise((resolve, reject) => {
                                parameters.EventType = EventType.KEY_DATE.val;
                                parameters.Id = "key_date_id";

                                getEvent(parameters).then(res => {
                                    if (res) {
                                        key_dates.push(res);
                                    }
                                    resolve();
                                });
                            }));
                            break;
                        }
                        case EventType.MOVEMENT: {
                            promise_array.push(new Promise((resolve, reject) => {
                                parameters.EventType = EventType.MOVEMENT.val;
                                parameters.Id = "movement_id";

                                getEvent(parameters).then(res => {
                                    if (res) {
                                        if (res.activityDate.actual != null) res.activityDate.val = new Date(res.activityDate.actual);
                                        else if (res.activityDate.scheduled != null) res.activityDate.val = new Date(res.activityDate.scheduled);
                                        movements.push(res);
                                    }
                                    resolve();
                                });
                            }));
                            break;
                        }
                        case EventType.STATE_TRAN: {
                            promise_array.push(new Promise((resolve, reject) => {
                                parameters.EventType = EventType.STATE_TRAN.val;
                                parameters.Id = "state_transition_id";

                                getEvent(parameters).then(res => {
                                    if (res) {
                                        //cornet doesn't include the event date in it's results, but we can get that from the crm notification
                                        //so we combine it up
                                        let notification = events.find(n => n.vsd_eventreferenceid == res.activityId);
                                        if (notification) {
                                            res.eventDate = new Date(notification.vsd_eventdate);
                                        }
                                        else res.eventDate = '';

                                        state_transitions.push(res);
                                    }
                                    resolve();
                                });
                            }));
                            break;
                        }
                        case EventType.VICT_CNTCT: {
                            promise_array.push(new Promise((resolve, reject) => {
                                parameters.EventType = EventType.VICT_CNTCT.val;
                                parameters.Id = "individual_id";

                                getEvent(parameters).then(res => {
                                    if (res) {
                                        victim_information.push(res);
                                    }
                                    resolve();
                                });
                            }));
                            break;
                        }
                    }
                }

                Promise.all(promise_array).then(() => {
                    if (no_content.length > 0) {
                        console.log("Tried to load " + events.length + " events. " + no_content.length + " of them returned no content from CORNET");
                        let events_no_content = [];
                        no_content.forEach(c => {
                            events_no_content.push(events.find(e => e.vsd_eventreferenceid == c.EventId && e.vsd_guid == c.Guid));
                        });
                        console.log(events_no_content);
                    }

                    if (key_dates.length > 0) {
                        key_dates.sort((a, b) => {
                            return new Date(b.activityDate).getTime() - new Date(a.activityDate).getTime();
                        });
                        $("#tab-key-dates").removeClass("is-disabled");
                        populateKeyDates();
                    }

                    if (offences.length > 0) {
                        //flatten out offences/charge counts for sorting purposes
                        let temp = [];
                        offences.forEach((offence, i) => {
                            offence.chargeCounts.forEach((charge, j) => {
                                let o = JSON.parse(JSON.stringify(offence));
                                o.expiryDateVal = '';
                                if (o.expiryDate != null) o.expiryDateVal = new Date(o.expiryDate);
                                delete o.chargeCounts;
                                temp.push({ ...o, ...charge });
                            });
                        });

                        //sort by file number descending - then by sequence number ascending - then by expiry date descending
                        temp.sort((a, b) => {
                            if (b.fileNumber == a.fileNumber) {
                                if (a.authorityDocumentId == b.authorityDocumentId) {
                                    if (a.countSeqNo == b.countSeqNo) {
                                        return new Date(b.expiryDate).getTime() - new Date(a.expiryDate).getTime();
                                    }
                                    else {
                                        return (a.countSeqNo > b.countSeqNo) ? 1 : -1;
                                    }
                                }
                                else {
                                    return b.authorityDocumentId.localeCompare(a.authorityDocumentId);
                                }
                            }
                            else {
                                let fileB = b.fileNumber || "";
                                let fileA = a.fileNumber || "";
                                return fileB.localeCompare(fileA);
                            }
                        });

                        offences = temp;

                        // $("#tab-offences").removeClass("is-disabled");
                        populateOffences();
                    }

                    if (movements.length > 0) {
                        movements.sort((a, b) => {
                            return b.activityDate.val.getTime() - a.activityDate.val.getTime();
                        });
                        // $("#tab-movements").removeClass("is-disabled");
                        populateMovements();
                    }

                    if (hearings.length > 0) {
                        // $("#tab-hearings").removeClass("is-disabled");
                        hearings.sort((a, b) => {
                            return b.activityDate.actualVal > a.activityDate.actualVal ? 1 : -1;
                        });
                        populateHearings();
                    }

                    if (victim_information.length > 0) {
                        // $("#tab-victim-info").removeClass("is-disabled");
                        victim_information.sort((a, b) => {
                            return a.personFullName.localeCompare(b.personFullName);
                        });
                        populateVictimInformation();
                    }

                    if (state_transitions.length > 0) {
                        // $("#tab-state-transition").removeClass("is-disabled");
                        state_transitions.sort((a, b) => {
                            return b.eventDate > a.eventDate ? 1 : -1;
                        });
                        populateStateTransitions();
                    }

                    resolve();
                });
            });
        }

        //load a single event from cornet
        function getEvent(parameters) {
            return new Promise((resolve, reject) => {
                var myHeaders = new Headers();
                myHeaders.append("username", parameters.UserName);
                myHeaders.append("fullname", parameters.FullName);
                myHeaders.append("client", parameters.Client);
                myHeaders.append("Content-Type", "application/json");

                var requestOptions = {
                    method: 'POST',
                    headers: myHeaders,
                    body: JSON.stringify(parameters),
                    credentials: "same-origin"
                };

                let endpoint = parent.Xrm.Page.context.getClientUrl();
                endpoint += "/api/data/v9.0/vsd_GetCORNETEvent";

                fetch(endpoint, requestOptions)
                    .then(response => response.text())
                    .then(res => {
                        let parsed = JSON.parse(res);
                        if (parsed && parsed.Result && parsed.IsSuccess) {
                            let data = JSON.parse(parsed.Result);
                            resolve(data);
                        }
                        else {
                            if (parsed && parsed.Result && parsed.Result.includes("No Content")) {
                                no_content.push(parameters);
                            }
                            resolve(null);
                        }
                    })
                    .catch(error => {
                        alert("Encountered an issue loading event info");
                        hideLoadingSpinner();
                        console.log('error', error);
                        reject(error);
                    });
            }).catch(err => {
                hideLoadingSpinner();
                reject(err);
            });
        }

        function loadMoreOffencesClick() {
            showLoadingSpinner();
            getHistoricalEvents(EventType.AUTH_DOCM.val).then((res) => {
                hideLoadMoreOffencesButton();
                hideLoadingSpinner();
                if (res && res.authorityDocuments && res.authorityDocuments.length > 0) {
                    more_offences = res.authorityDocuments;
                    if (more_offences.length > 0) {
                        //flatten out offences/charge counts for sorting purposes
                        let temp = [];
                        more_offences.forEach((offence, i) => {
                            offence.expiryDateVal = '';
                            if (offence.expiryDate != null) offence.expiryDateVal = new Date(offence.expiryDate);
                            offence.chargeCounts.forEach((charge, j) => {
                                let o = JSON.parse(JSON.stringify(offence));
                                o.expiryDateVal = '';
                                if (o.expiryDate != null) o.expiryDateVal = new Date(o.expiryDate);
                                delete o.chargeCounts;
                                temp.push({ ...o, ...charge });
                            });
                        });

                        //sort by file number descending - then by sequence number ascending - then by expiry date descending
                        temp.sort((a, b) => {
                            if (b.fileNumber == a.fileNumber) {
                                if (a.authorityDocumentId == b.authorityDocumentId) {
                                    if (a.countSeqNo == b.countSeqNo) {
                                        return new Date(b.expiryDate).getTime() - new Date(a.expiryDate).getTime();
                                    }
                                    else {
                                        return (a.countSeqNo > b.countSeqNo) ? 1 : -1;
                                    }
                                }
                                else {
                                    // return b.authorityDocumentId.localeCompare(a.authorityDocumentId);
                                    return new Date(b.expiryDate).getTime() - new Date(a.expiryDate).getTime();
                                }
                            }
                            else {
                                let fileB = b.fileNumber || "";
                                let fileA = a.fileNumber || "";
                                return fileB.localeCompare(fileA);
                            }
                        });

                        more_offences = temp;
                        populateMoreOffences();
                    }
                } else {
                    $(".no-more-offences").removeClass("hidden");
                }
            }).catch(err => {
                hideLoadingSpinner();
                console.log(err);
            });
        }

        function loadMoreMovementsClick() {
            showLoadingSpinner();
            getHistoricalEvents(EventType.MOVEMENT.val).then((res) => {
                hideLoadMoreMovementsButton();
                hideLoadingSpinner();
                if (res && res.movements && res.movements.length > 0) {
                    more_movements = res.movements;
                    more_movements.forEach(movement => {
                        if (movement.activityDate.actual != null) movement.activityDate.val = new Date(movement.activityDate.actual);
                        else if (movement.activityDate.scheduled != null) movement.activityDate.val = new Date(movement.activityDate.scheduled);
                    });
                    more_movements.sort((a, b) => {
                        return b.activityDate.val.getTime() - a.activityDate.val.getTime();
                    });
                    populateMoreMovements();
                }
                else {
                    $(".no-more-movements").removeClass("hidden");
                }
            }).catch(err => {
                hideLoadingSpinner();
                console.log(err);
            });
        }

        function loadMoreHearingsClick() {
            showLoadingSpinner();
            getHistoricalEvents(EventType.HEARING.val).then((res) => {
                hideLoadMoreHearingsButton()
                hideLoadingSpinner();
                if (res && res.hearings && res.hearings.length > 0) {
                    more_hearings = res.hearings;
                    more_hearings.forEach(hearing => {
                        hearing.activityDate.actualVal = '';
                        hearing.activityDate.scheduledVal = '';
                        if (hearing.activityDate.actual != null) hearing.activityDate.actualVal = new Date(hearing.activityDate.actual.slice(0, 10) + "T00:00:00");
                        if (hearing.activityDate.scheduled != null) hearing.activityDate.scheduledVal = new Date(hearing.activityDate.scheduled.slice(0, 10) + "T00:00:00");
                    });
                    populateMoreHearings();
                }
                else {
                    $(".no-more-hearings").removeClass("hidden");
                }
            }).catch(err => {
                hideLoadingSpinner();
                console.log(err);
            });
        }

        function loadMoreVictimsClick() {
            showLoadingSpinner();
            getHistoricalEvents(EventType.VICT_CNTCT.val).then((res) => {
                hideLoadMoreVictimsButton();
                hideLoadingSpinner();
                if (res && res.victimContacts && res.victimContacts.length > 0) {
                    more_victim_information = res.victimContacts;
                    populateMoreVictimInformation();
                }
                else {
                    $(".no-more-victims").removeClass("hidden");
                }
            }).catch(err => {
                hideLoadingSpinner();
                console.log(err);
            });
        }

        function loadMoreStateTransitionsClick() {
            showLoadingSpinner();
            getHistoricalEvents(EventType.STATE_TRAN.val).then((res) => {
                hideLoadMoreStateTransitionsButton();
                hideLoadingSpinner();
                if (res && res.stateTransitions && res.stateTransitions.length > 0) {
                    more_state_transitions = res.stateTransitions;
                    more_state_transitions.forEach(state_transition => {
                        state_transition.eventDate = "";
                    });
                    populateMoreStateTransitions();
                }
                else {
                    $(".no-more-state-transitions").removeClass("hidden");
                }
            }).catch(err => {
                hideLoadingSpinner();
                console.log(err);
            });
        }

        function loadMoreKeyDatesClick() {
            showLoadingSpinner();
            getHistoricalEvents(EventType.KEY_DATE.val).then((res) => {
                hideLoadMoreKeyDatesButton();
                hideLoadingSpinner();
                if (res && res.keyDates && res.keyDates.length > 0) {
                    more_key_dates = res.keyDates;
                    more_key_dates.sort((a, b) => {
                        return new Date(b.activityDate).getTime() - new Date(a.activityDate).getTime();
                    });
                    populateMoreKeyDates();
                }
                else {
                    $(".no-more-key-dates").removeClass("hidden");
                }
            }).catch(err => {
                hideLoadingSpinner();
                console.log(err);
            });
        }

        function pad(num, size) {
            num = num.toString();
            while (num.length < size) num = "0" + num;
            return num;
        }

        function getHistoricalEvents(eventType) {
            return new Promise((resolve, reject) => {
                let parameters = {
                    EventType: eventType,
                    IsHistory: true,
                    UserName: "Test",
                    FullName: "Test",
                    Client: client_details.clientNumber, //"03377256", //cs number with state transitions...
                    StartDate: "2018-05-01T07:00:00.000Z", //start of day May 1, 2018
                    EndDate: "2020-05-13T06:59:00.000Z" //end of day May 12, 2020 - event cut off date we received from NTT
                };

                getEvent(parameters).then(res => {
                    resolve(res);
                }).catch((err) => {
                    console.log(err);
                    hideLoadingSpinner();
                });
            });
        }

        function populateMoreKeyDates() {
            $("#more-key-dates").find("div:gt(0)").remove();
            $("#more-key-dates-table").find("tr:gt(0)").remove();
            $(".more-key-dates-container").removeClass("hidden");

            more_key_dates.forEach((keyDate, i) => {
                // let div = `<div class="col-4">
                //                 <label for="offenderKeyDate${i}" class="offenderKeyDate${i}">${keyDate.activityCategory.description || ''}</label>
                //                 <br>
                //                 <input class="form-control offenderKeyDate read-only" type="text" id="offenderKeyDate${i}" name="offenderKeyDate${i}" value="${keyDate.activityDate || ''}">
                //             </div>`;
                // $("#key-dates").append(div);

                let tr = `<tr>
                            <td>${keyDate.activityDate ? new Date(keyDate.activityDate + "T00:00:00").toLocaleString('en-us', { month: "short", day: 'numeric', year: 'numeric' }) : ''}</td>
                            <td>${keyDate.activityCategory.description || ''}</td>
                            <td>${keyDate.activityCategory.code || ''}</td>
                            <td>${keyDate.sentenceCalcTypeCd || ''}</td>
                            <td>${keyDate.activityDescription || ''}</td>
                        </tr>`;
                $("#more-key-dates-table").append(tr);
            });
        }

        function populateMoreOffences() {
            $("#more-offences-table").find("tr:gt(0)").remove();
            $(".more-offences-container").removeClass("hidden");

            more_offences.forEach((offence, i) => {
                let tr = `<tr>
                        <td>${offence.fileNumber || ''}</td>
                        <td>${offence.countSeqNo || ''}</td>
                        <td>${offence.courtLocationDescription || ''}</td>
                        <td>${offence.statuteAct || ''}</td>
                        <td>${offence.statuteSectionNo || ''}</td>
                        <td>${offence.statuteSubsectionParagraph || ''}</td>
                        <td>${offence.statuteDescription || ''}</td>
                        <td>${offence.documentTypeCode || ''}</td>
                        <td>${offence.expiryDateVal.toLocaleString('en-us', { month: "short", day: 'numeric', year: 'numeric' })}</td>
                        </tr>`;
                $("#more-offences-table").append(tr);
            });
        }

        function populateMoreMovements() {
            $("#more-movements-table").find("tr:gt(0)").remove();
            $(".more-movements-container").removeClass("hidden");

            more_movements.forEach((movement, i) => {
                let tr = `<tr>
                            <td>${movement.activityDate.val.toLocaleString('en-us', { month: "short", day: 'numeric', year: 'numeric' })}</td>
                            <td>${movement.activityDate.val.toLocaleTimeString()}</td>
                            <td>${movement.activityCategory.description || ''}</td>
                            <td>${movement.activitySubCategory.code || ''}</td>
                            <td>${movement.activityReason.description || ''}</td>
                            <td>${movement.supervisionFacility.to || ''}</td>
                            <td>${movement.activityDescription || ''}</td>
                        </tr>`;
                $("#more-movements-table").append(tr);
            });
        }

        function populateMoreHearings() {
            $("#more-hearings-table").find("tr:gt(0)").remove();
            $(".more-hearings-container").removeClass("hidden");

            more_hearings.forEach((hearing, i) => {
                let tr = `<tr>
                            <td>${hearing.activityDate.actualVal ? hearing.activityDate.actualVal.toLocaleString('en-us', { month: "short", day: 'numeric', year: 'numeric' }) : ''}</td>
                            <td>${hearing.hearingCategory.description || ''}</td>
                            <td>${hearing.activityDate.scheduledVal ? hearing.activityDate.scheduledVal.toLocaleString('en-us', { month: "short", day: 'numeric', year: 'numeric' }) : ''}</td>
                            <td>${hearing.activityType.description || ''}</td>
                            <td>${hearing.hearingRequestType.description || ''}</td>
                            <td>${hearing.hearingDecision.description || ''}</td>
                        </tr>`;
                $("#more-hearings-table").append(tr);
            });
        }

        function populateMoreVictimInformation() {
            $("#more-victim-information-table").find("tr:gt(0)").remove();
            $(".more-victims-container").removeClass("hidden");

            more_victim_information.forEach((victim, i) => {
                let tr = `<tr>
                            <td>${victim.personFullName || ''}</td>
                            <td>${victim.victimToPersonRelationship || ''}</td>
                            <td>${'<button onclick="showMoreVictimDetailsClick(' + i + ')" class="btn btn-secondary">View Details</button>'}</td>
                        </tr>`;
                $("#more-victim-information-table").append(tr);
            });
        }

        function populateMoreStateTransitions() {
            $("#more-state-transitions-table").find("tr:gt(0)").remove();
            $(".more-state-transitions-container").removeClass("hidden");

            more_state_transitions.forEach((transition, i) => {
                let tr = `<tr>
                            <td>${transition.eventDate ? transition.eventDate.toLocaleString('en-us', { month: "short", day: 'numeric', year: 'numeric' }) : ''}</td>
                            <td>${transition.activityType.code || ''}</td>
                            <td>${transition.activitySubType.code || ''}</td>
                            <td>${transition.activityReason.description || ''}</td>
                        </tr>`;
                $("#more-state-transitions-table").append(tr);
            });
        }

        //used when leaving the details page to ensure a fresh slate if the user loads a new offender
        function clearOffenderDetails() {
            //clear offender details variables
            OFFENDER_EXISTS_IN_COAST = false;
            client_details = {};
            coastInfo = {};
            events = [];
            offences = [];
            movements = [];
            hearings = [];
            victim_information = [];
            state_transitions = [];
            key_dates = [];
            more_offences = [];
            more_movements = [];
            more_hearings = [];
            more_victim_information = [];
            more_state_transitions = [];
            more_key_dates = [];
            //clear subject information inputs and victim details inputs
            OffenderDetailsFields.forEach(field => {
                $(`#${field}`).val('');
            });
            OffenderDetailsCheckboxes.forEach(field => {
                $(`#${field}`).prop("checked", false);
            });
            VictimDetailsFields.forEach(field => {
                $(`#${field}`).val('');
            });
            //ensure victim contact labels are "not primary"
            $("label.victimTelephone").removeClass("is-primary-contact");
            $("label.victimMobile").removeClass("is-primary-contact");
            $("label.victimEmail").removeClass("is-primary-contact");
            //hide sections that are dependant on the existence of certain offender data
            $(".offender-coast-info").addClass("hidden");
            $(".custody-location").addClass("hidden");
            $(".community-location").addClass("hidden");
            $(".victim-details-container").addClass("hidden");
            //disabled all tabs
            // $("#tab-offences").addClass("is-disabled");
            // $("#tab-movements").addClass("is-disabled");
            // $("#tab-hearings").addClass("is-disabled");
            // $("#tab-victim-info").addClass("is-disabled");
            // $("#tab-state-transition").addClass("is-disabled");
            // $("#tab-key-dates").addClass("is-disabled");
            //hide historical data tables
            $(".more-offences-container").addClass("hidden");
            $(".no-more-offences").addClass("hidden");
            $(".more-movements-container").addClass("hidden");
            $(".no-more-movements").addClass("hidden");
            $(".more-hearings-container").addClass("hidden");
            $(".no-more-hearings").addClass("hidden");
            $(".more-victims-container").addClass("hidden");
            $(".no-more-victims").addClass("hidden");
            $(".more-state-transitions-container").addClass("hidden");
            $(".no-more-state-transitions").addClass("hidden");
            $(".more-key-dates-container").addClass("hidden");
            $(".no-more-key-dates").addClass("hidden");
            //show all load more buttons
            showLoadMoreOffencesButton();
            showLoadMoreMovementsButton();
            showLoadMoreHearingsButton();
            showLoadMoreVictimsButton();
            showLoadMoreStateTransitionsButton();
            showLoadMoreKeyDatesButton();
            //empty all tables/key dates
            $("#key-dates").find("div:gt(0)").remove();
            $("#offences-table").find("tr:gt(0)").remove();
            $("#movements-table").find("tr:gt(0)").remove();
            $("#hearings-table").find("tr:gt(0)").remove();
            $("#victim-information-table").find("tr:gt(0)").remove();
            $("#sate-transitions-table").find("tr:gt(0)").remove();
            $("#key-dates-table").find("tr:gt(0)").remove();
            //set subject info as selected tab - show/hide as needed
            let tab = "subject-information-container";
            let toHide = TABS.filter(t => t != tab);
            toHide.forEach(t => {
                $(`#${t}`).addClass("hidden");
            });

            $(`#${tab}`).removeClass("hidden");

            $(".nav-link").removeClass("active-page");
            $("#tab-subject-info").addClass("active-page");

            enableLinkOffenderButton();
        }

        //functions to populate the various sections of the client details page
        function populateSubjectInformation() {
            // console.log("setting subject info");
            // console.log(client_details);

            $("#offenderLastName").val(client_details.lastName);
            $("#offenderGivenNames").val(client_details.givenNames);
            $("#offenderCurrentName").prop("checked", client_details.isCurrentName == 'Y');

            $("#offenderGender").val(client_details.personGenderIdentityCodeType);
            $("#offenderBirthdate").val(client_details.personBirthDate);
            $("#offenderAliases").val(client_details.aliases);

            $("#offenderCS").val(client_details.clientNumber);

            if (client_details.coastInfo) {
                $(".offender-coast-info").removeClass("hidden");

                $("#offenderInCustody").prop("checked", client_details.coastInfo.vsd_incustody === CRMBoolean.True);
                $("#offenderInOut").prop("checked", client_details.coastInfo.vsd_inout === CRMBoolean.True);
                $("#offenderIntermittentSentence").prop("checked", client_details.coastInfo.vsd_intermittentsentence === CRMBoolean.True);


                $("#offenderCommunityStatus").prop("checked", client_details.coastInfo.vsd_communitystatus === CommunityStatus.Active);
                $("#offenderAWOL").prop("checked", client_details.coastInfo.vsd_awol === CRMBoolean.True);

                $("#offenderProbationOfficer").val(client_details.coastInfo.vsd_probationofficerbailsupervisor);
                $("#offenderReportingOrder").prop("checked", client_details.coastInfo.vsd_reportingorder === CRMBoolean.True);
                $("#offenderPoliceFileNumber").val(client_details.coastInfo.vsd_policefilenumber);
            }

            if (client_details.locationTypeCode.custody) {
                $(".custody-location").removeClass("hidden");
                $("#offenderCustodyLocation").val(client_details.locationTypeCode.custody);
            }
            if (client_details.locationTypeCode.community) {
                $(".offender-coast-info").removeClass("hidden");
                $(".community-location").removeClass("hidden");
                $("#offenderCommunityLocation").val(client_details.locationTypeCode.community);
            }
        }

        function populateKeyDates() {
            $("#key-dates").find("div:gt(0)").remove();
            $("#key-dates-table").find("tr:gt(0)").remove();

            key_dates.forEach((keyDate, i) => {
                let div = `<div class="col-4">
                                <label for="offenderKeyDate${i}" class="offenderKeyDate${i}">${keyDate.activityCategory.description || ''}</label>
                                <br>
                                <input class="form-control offenderKeyDate read-only" type="text" id="offenderKeyDate${i}" name="offenderKeyDate${i}" value="${keyDate.activityDate || ''}">
                            </div>`;
                $("#key-dates").append(div);

                let tr = `<tr>
                            <td>${keyDate.activityDate ? new Date(keyDate.activityDate + "T00:00:00").toLocaleString('en-us', { month: "short", day: 'numeric', year: 'numeric' }) : ''}</td>
                            <td>${keyDate.activityCategory.description || ''}</td>
                            <td>${keyDate.activityCategory.code || ''}</td>
                            <td>${keyDate.sentenceCalcTypeCd || ''}</td>
                            <td>${keyDate.activityDescription || ''}</td>
                        </tr>`;
                $("#key-dates-table").append(tr);
            });
        }

        function populateOffences() {
            $("#offences-table").find("tr:gt(0)").remove();

            offences.forEach((offence, i) => {
                let tr = `<tr>
                        <td>${offence.fileNumber || ''}</td>
                        <td>${offence.countSeqNo || ''}</td>
                        <td>${offence.courtLocationDescription || ''}</td>
                        <td>${offence.statuteAct || ''}</td>
                        <td>${offence.statuteSectionNo || ''}</td>
                        <td>${offence.statuteSubsectionParagraph || ''}</td>
                        <td>${offence.statuteDescription || ''}</td>
                        <td>${offence.documentTypeCode || ''}</td>
                        <td>${offence.expiryDateVal.toLocaleString('en-us', { month: "short", day: 'numeric', year: 'numeric' })}</td>
                        </tr>`;
                $("#offences-table").append(tr);
            });
        }

        function populateMovements() {
            $("#movements-table").find("tr:gt(0)").remove();

            movements.forEach((movement, i) => {
                let tr = `<tr>
                            <td>${movement.activityDate.val.toLocaleString('en-us', { month: "short", day: 'numeric', year: 'numeric' })}</td>
                            <td>${movement.activityDate.val.toLocaleTimeString()}</td>
                            <td>${movement.activityCategory.description || ''}</td>
                            <td>${movement.activitySubCategory.code || ''}</td>
                            <td>${movement.activityReason.description || ''}</td>
                            <td>${movement.supervisionFacility.to || ''}</td>
                            <td>${movement.activityDescription || ''}</td>
                        </tr>`;
                $("#movements-table").append(tr);
            });
        }

        function populateHearings() {
            $("#hearings-table").find("tr:gt(0)").remove();

            hearings.forEach((hearing, i) => {
                let tr = `<tr>
                            <td>${hearing.activityDate.actualVal ? hearing.activityDate.actualVal.toLocaleString('en-us', { month: "short", day: 'numeric', year: 'numeric' }) : ''}</td>
                            <td>${hearing.hearingCategory.description || ''}</td>
                            <td>${hearing.activityDate.scheduledVal ? hearing.activityDate.scheduledVal.toLocaleString('en-us', { month: "short", day: 'numeric', year: 'numeric' }) : ''}</td>
                            <td>${hearing.activityType.description || ''}</td>
                            <td>${hearing.hearingRequestType.description || ''}</td>
                            <td>${hearing.hearingDecision.description || ''}</td>
                        </tr>`;
                $("#hearings-table").append(tr);
            });
        }

        function populateVictimInformation() {
            $("#victim-information-table").find("tr:gt(0)").remove();

            victim_information.forEach((victim, i) => {
                let tr = `<tr>
                            <td>${victim.personFullName || ''}</td>
                            <td>${victim.victimToPersonRelationship || ''}</td>
                            <td>${'<button onclick="showVictimDetailsClick(' + i + ')" class="btn btn-secondary">View Details</button>'}</td>
                        </tr>`;
                $("#victim-information-table").append(tr);
            });
        }

        function populateStateTransitions() {
            $("#state-transitions-table").find("tr:gt(0)").remove();

            state_transitions.forEach((transition, i) => {
                let tr = `<tr>
                            <td>${transition.eventDate ? transition.eventDate.toLocaleString('en-us', { month: "short", day: 'numeric', year: 'numeric' }) : ''}</td>
                            <td>${transition.activityType.code || ''}</td>
                            <td>${transition.activitySubType.code || ''}</td>
                            <td>${transition.activityReason.description || ''}</td>
                        </tr>`;
                $("#state-transitions-table").append(tr);
            });
        }

        function showMoreVictimDetailsClick(index) {
            let victim = more_victim_information[index];
            displayVictimDetails(victim);
        }

        function showVictimDetailsClick(index) {
            let victim = victim_information[index];
            displayVictimDetails(victim);
        }

        function displayVictimDetails(victim) {
            $(".victim-details-container").removeClass("hidden");

            $("#victimName").val(victim.personFullName || '');
            $("#victimComment").val(victim.victimContactComment || '');
            $("#victimEffectiveDate").val(victim.victimContactDate.effective || '');
            $("#victimExpiryDate").val(victim.victimContactDate.expiry || '');
            $("#victimPrimaryAddress").val(victim.primaryAddressFull || '');
            $("#victimSecondaryAddress").val(victim.secondaryAddressFull || '');
            $("#victimMailingAddress").val(victim.mailingAddressFull || '');
            $("#victimBusinessAddress").val(victim.businessAddressFull || '');
            $("#victimTelephone").val(victim.telephoneNumberType.number || '');
            $("#victimTelephoneEffectiveDate").val(victim.telephoneNumberType.effectiveDate || '');
            $("#victimMobile").val(victim.cellNumberType.number || '');
            $("#victimMobileEffectiveDate").val(victim.cellNumberType.effectiveDate || '');
            $("#victimEmail").val(victim.emailType.emailAddress || '');
            $("#victimEmailEffectiveDate").val(victim.emailType.effectiveDate || '');

            if (victim.telephoneNumberType.isPrimary == "Y") {
                $("label.victimTelephone").addClass("is-primary-contact");
            }
            else {
                $("label.victimTelephone").removeClass("is-primary-contact");
            }
            if (victim.cellNumberType.isPrimary == "Y") {
                $("label.victimMobile").addClass("is-primary-contact");
            }
            else {
                $("label.victimMobile").removeClass("is-primary-contact");
            }
            if (victim.emailType.isPrimary == "Y") {
                $("label.victimEmail").addClass("is-primary-contact");
            }
            else {
                $("label.victimEmail").removeClass("is-primary-contact");
            }
        }

        function linkOffenderClick() {
            if (FORM_TYPE === FormTypes.OFFENDER) {
                linkOffender();
            }
            else if (FORM_TYPE === FormTypes.SUBJECT) {
                createAndLink();
            }
        }

        //Sets COAST offender info to that of the info we have from Cornet
        function linkOffender() {
            hideLinkOffenderButton();
            hideReturnToSearchButton();
            showLoadingSpinner();

            let birthdate = new Date(client_details.personBirthDate + "T00:00:00");
            let gender = getOptionsSetFromName(GenderOptionSet, client_details.personGenderIdentityCodeType);

            parent.Xrm.Page.getAttribute("vsd_csnumber").setValue(client_details.clientNumber);
            parent.Xrm.Page.getAttribute("vsd_firstname").setValue(client_details.givenNames);
            parent.Xrm.Page.getAttribute("vsd_lastname").setValue(client_details.lastName);
            parent.Xrm.Page.getAttribute("vsd_birthdate").setValue(birthdate);
            parent.Xrm.Page.getAttribute("vsd_gender").setValue(gender.val);
            parent.Xrm.Page.getAttribute("vsd_aliasnames").setValue(client_details.aliasesForCRM);
            parent.Xrm.Page.data.entity.save();

            //small delay to let the crm page save so that when we reload we get accurate info
            setTimeout(async () => {
                OFFENDER_EXISTS_IN_COAST = true;
                await postLinkCreateCOASTOffences();
                loadOffender(client_details.clientNumber, OffenderIdType.CS_NUMBER);
            }, 2000);
        }

        //Links the cornet offender info to the Subject
        function createAndLink() {
            hideLinkOffenderButton();
            hideReturnToSearchButton();
            showLoadingSpinner();
            if (OFFENDER_EXISTS_IN_COAST) {
                //link only
                let link_data = [{
                    entityType: "vsd_offender",
                    id: coastInfo.vsd_offenderid,
                    name: client_details.clientNumber,
                }]
                parent.Xrm.Page.getAttribute("vsd_offender").setValue(link_data);
                parent.Xrm.Page.data.entity.save();

                //small delay to let the crm page save so that when we reload we get accurate info
                setTimeout(async () => {
                    await postLinkCreateCOASTOffences();
                    loadOffender(client_details.clientNumber, OffenderIdType.CS_NUMBER);
                    // hideLoadingSpinner();
                }, 2000);
            }
            else {
                //create then link
                createCOASTOffender().then((res) => {
                    getCOASTOffender(client_details.clientNumber, OffenderIdType.CS_NUMBER).then((offender) => {
                        if (!$.isEmptyObject(offender)) {
                            let link_data = [{
                                entityType: "vsd_offender",
                                id: offender.vsd_offenderid,
                                name: client_details.clientNumber,
                            }]
                            parent.Xrm.Page.getAttribute("vsd_offender").setValue(link_data);
                            parent.Xrm.Page.data.entity.save();

                            //small delay to let the crm page save so that when we reload we get accurate info
                            setTimeout(async () => {
                                OFFENDER_EXISTS_IN_COAST = true;
                                await postLinkCreateCOASTOffences();
                                loadOffender(client_details.clientNumber, OffenderIdType.CS_NUMBER);
                                // hideLoadingSpinner();
                            }, 2000);
                        }
                        else {
                            hideLoadingSpinner();
                        }
                    }).catch((err) => {
                        hideLoadingSpinner();
                        console.log(err);
                        hideLoadingSpinner();
                    });
                }).catch((err) => {
                    hideLoadingSpinner();
                    console.log(err);
                    hideLoadingSpinner();
                });
            }
        }

        function postLinkCreateCOASTOffences() {
            return new Promise((resolve, reject) => {
                var myHeaders = new Headers();
                myHeaders.append("Content-Type", "application/json");

                let endpoint = parent.Xrm.Page.context.getClientUrl();
                endpoint += "/api/data/v9.0/vsd_cornetoffences";

                let today = new Date();

                getCOASTOffender(client_details.clientNumber, OffenderIdType.CS_NUMBER).then(offender => {
                    let promise_array = [];

                    offences.forEach((offence, i) => {
                        let isExpired = false;
                        if (offence.expiryDateVal instanceof Date) isExpired = today > offence.expiryDateVal;
                        let expiryVal = offence.expiryDateVal;
                        if (expiryVal) expiryVal = expiryVal.toISOString();

                        let data = {
                            "vsd_OffenderId@odata.bind": `/vsd_offenders(${offender.vsd_offenderid})`,
                            vsd_authoritydocumentid: offence.authorityDocumentId,
                            vsd_clientnumber: client_details.clientNumber,

                            vsd_courtlocationcode: offence.courtLocationCode,
                            vsd_courtlocationdescription: offence.courtLocationDescription,
                            vsd_documenttypecode: offence.documentTypeCode || '',
                            vsd_documenttypedescription: offence.documentTypeDescription || '',
                            vsd_filenumber: offence.fileNumber || '',
                            vsd_statutesubsectionparagraph: offence.statuteSubsectionParagraph || '',
                            vsd_statutedescription: offence.statuteDescription || '',
                            vsd_statutesectionno: offence.statuteSectionNo || '',
                            vsd_countseqno: offence.countSeqNo ? offence.countSeqNo.toString() : '',
                            vsd_statuteact: offence.statuteAct || '',
                        }

                        if (expiryVal) data['vsd_expirydate'] = expiryVal;

                        var requestOptions = {
                            method: 'POST',
                            headers: myHeaders,
                            body: JSON.stringify(data),
                            credentials: "same-origin"
                        };

                        promise_array.push(new Promise((resolve, reject) => {
                            fetch(endpoint, requestOptions)
                                .then(response => {
                                    let uri = response.headers.get("odata-entityid");
                                    let regExp = /\(([^)]+)\)/;
                                    let matches = regExp.exec(uri);
                                    let newEntityId = matches[1];
                                    return newEntityId;
                                })
                                .then(async (id) => {
                                    if (isExpired) await setOffenceAsInactive(id);
                                    resolve();
                                })
                                .catch(error => {
                                    hideLoadingSpinner();
                                    console.log('error', error);
                                    reject(error)
                                });
                        }));
                    });

                    Promise.all(promise_array).then((res) => {
                        resolve();
                    }).catch((err) => {
                        hideLoadingSpinner();
                        reject(err);
                    });
                });
            });
        }

        function setOffenceAsInactive(id) {
            return new Promise((resolve, reject) => {
                var myHeaders = new Headers();
                myHeaders.append("Content-Type", "application/json");

                let endpoint = parent.Xrm.Page.context.getClientUrl();
                endpoint += `/api/data/v9.0/vsd_cornetoffences(${id})`;

                let data = { statuscode: StatusCode.Inactive, statecode: StateCode.Inactive };

                var requestOptions = {
                    method: 'PATCH',
                    headers: myHeaders,
                    body: JSON.stringify(data),
                    credentials: "same-origin"
                };

                fetch(endpoint, requestOptions)
                    .then(response => response.text())
                    .then(res => {
                        resolve();
                    })
                    .catch(error => {
                        hideLoadingSpinner();
                        console.log('error', error);
                        reject();
                    });
            });
        }

        function createCOASTOffender() {
            return new Promise((resolve, reject) => {
                let birthdate = new Date(client_details.personBirthDate + "T00:00:00");
                let gender = getOptionsSetFromName(GenderOptionSet, client_details.personGenderIdentityCodeType);

                let data = {
                    vsd_csnumber: client_details.clientNumber,
                    vsd_firstname: client_details.givenNames,
                    vsd_lastname: client_details.lastName,
                    vsd_birthdate: client_details.birthdate,
                    vsd_gender: gender.val,
                    vsd_aliasnames: client_details.aliasesForCRM,
                }

                var myHeaders = new Headers();
                myHeaders.append("Content-Type", "application/json");

                let endpoint = parent.Xrm.Page.context.getClientUrl();
                endpoint += "/api/data/v9.0/vsd_offenders";

                var requestOptions = {
                    method: 'POST',
                    headers: myHeaders,
                    body: JSON.stringify(data),
                    credentials: "same-origin"
                };

                fetch(endpoint, requestOptions)
                    .then(response => response.text())
                    .then(res => {
                        resolve();
                    })
                    .catch(error => {
                        alert("Encountered an issue trying to create an Offender in COAST.");
                        hideLoadingSpinner();
                        console.log('error', error);
                        reject(error)
                    });
            }).catch(err => {
                hideLoadingSpinner();
                reject(err);
            });
        }

        function isOffenderAlreadyLinkedToSubject() {
            return new Promise((resolve, reject) => {
                var myHeaders = new Headers();
                myHeaders.append("Content-Type", "application/json");

                var requestOptions = {
                    method: 'GET',
                    headers: myHeaders,
                    credentials: "same-origin"
                };

                let endpoint = parent.Xrm.Page.context.getClientUrl();
                endpoint += `/api/data/v9.0/vsd_caseoffenders?$filter=_vsd_offender_value eq ${coastInfo.vsd_offenderid}`;

                fetch(endpoint, requestOptions)
                    .then(response => response.text())
                    .then(res => {
                        let data = JSON.parse(res);
                        if (data && data.value && data.value.length > 0) {
                            resolve(true);
                        }
                        else {
                            resolve(false);
                        }
                    })
                    .catch(error => {
                        hideLoadingSpinner();
                        console.log('error', error);
                        reject(error)
                    });
            }).catch(err => {
                hideLoadingSpinner();
                reject(err);
            });
        }

        function showTabContent(event, tab) {
            let toHide = TABS.filter(t => t != tab);
            toHide.forEach(t => {
                $(`#${t}`).addClass("hidden");
            });

            $(`#${tab}`).removeClass("hidden");

            $(".nav-link").removeClass("active-page");
            event.currentTarget.className += " active-page";
        }

        //helpers to show/hide sections/buttons
        function showLoadingSpinner() {
            $(".loading-indicator").removeClass("hidden");
        }

        function hideLoadingSpinner() {
            $(".loading-indicator").addClass("hidden");
        }

        function showSearchSection() {
            $("#search-container").removeClass("hidden");
        }

        function hideSearchSection() {
            $("#search-container").addClass("hidden");
        }

        function showClientDetailsSection() {
            $("#client-details-container").removeClass("hidden");
        }

        function hideClientDetailsSection() {
            $("#client-details-container").addClass("hidden");
        }

        function showLinkOffenderButton() {
            $("#link-offender").removeClass("hidden");
        }

        function hideLinkOffenderButton() {
            $("#link-offender").addClass("hidden");
        }

        function disableLinkOffenderButton() {
            $(".btn-link-offender").addClass("is-disabled");
        }

        function enableLinkOffenderButton() {
            $(".btn-link-offender").removeClass("is-disabled");
        }

        function showReturnToSearchButton() {
            $("#return-to-search").removeClass("hidden");
        }

        function hideReturnToSearchButton() {
            $("#return-to-search").addClass("hidden");
        }

        function disableSearchButton() {
            $("#search-button").addClass("is-disabled");
        }

        function enableSearchButton() {
            $("#search-button").removeClass("is-disabled");
        }

        function emptySearchResultsTable() {
            $("#client-table").find("tr:gt(0)").remove();
        }

        function hideLoadMoreOffencesButton() {
            $(".load-more-offences-row").addClass("hidden");
        }

        function showLoadMoreOffencesButton() {
            $(".load-more-offences-row").removeClass("hidden");
        }

        function hideLoadMoreMovementsButton() {
            $(".load-more-movements-row").addClass("hidden");
        }

        function showLoadMoreMovementsButton() {
            $(".load-more-movements-row").removeClass("hidden");
        }

        function hideLoadMoreHearingsButton() {
            $(".load-more-hearings-row").addClass("hidden");
        }

        function showLoadMoreHearingsButton() {
            $(".load-more-hearings-row").removeClass("hidden");
        }

        function hideLoadMoreVictimsButton() {
            $(".load-more-victims-row").addClass("hidden");
        }

        function showLoadMoreVictimsButton() {
            $(".load-more-victims-row").removeClass("hidden");
        }

        function hideLoadMoreStateTransitionsButton() {
            $(".load-more-state-transitions-row").addClass("hidden");
        }

        function showLoadMoreStateTransitionsButton() {
            $(".load-more-state-transitions-row").removeClass("hidden");
        }

        function hideLoadMoreKeyDatesButton() {
            $(".load-more-key-dates-row").addClass("hidden");
        }

        function showLoadMoreKeyDatesButton() {
            $(".load-more-key-dates-row").removeClass("hidden");
        }

        function scrollPageToTop() {
            parent.document.querySelectorAll("#tablist")[0].scrollIntoView(true);
        }

        function getOptionsSetVal(optionSet, val) {
            return Object.values(optionSet).find((o) => o.val == val);
        }

        function getOptionsSetFromName(optionSet, name) {
            return Object.values(optionSet).find((o) => o.name == name);
        }
    </script>
</body>

</html>